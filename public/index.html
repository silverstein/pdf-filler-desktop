<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Filler - Free AI-Powered PDF Processing</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="themes.css">
    
    <!-- Lucide Icons (local) -->
    <script src="lucide.min.js"></script>
    
    <!-- Use system fonts as fallback when Google Fonts aren't available -->
    <style>
        /* Fallback to system fonts */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
        }
        code, pre {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        }
        
        /* Fix for Lucide icons - ensure they're not solid blocks */
        i[data-lucide] {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: transparent !important;
        }
        
        /* When Lucide replaces with SVG */
        svg.lucide {
            fill: none !important;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
    </style>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Stack header on top */
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        .header {
            height: 60px; /* Fixed height header */
            width: 100%;
            flex-shrink: 0;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .app-layout {
            display: flex; /* Sidebar and main side by side */
            flex: 1;
            overflow: hidden;
            height: calc(100vh - 60px); /* Full viewport minus header height */
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        /* Desktop sidebar toggle in header */
        .header-sidebar-toggle {
            background: transparent;
            border: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            margin-right: 1rem;
        }
        
        .header-sidebar-toggle:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .account-dropdown {
            position: relative;
        }

        .account-trigger {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .account-trigger:hover {
            background: var(--surface-hover);
        }

        .account-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            min-width: 200px;
            z-index: 1000;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .account-menu.show {
            display: block;
        }

        .account-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
        }

        .account-menu-item:hover {
            background: var(--surface-hover);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            background: transparent;
            border: 1px solid transparent;
        }

        .icon-btn:hover {
            background: var(--surface-hover);
            border-color: var(--border);
        }

        .settings-view {
            display: none;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .theme-card {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .theme-card.active {
            border-color: var(--accent);
            background: var(--surface-hover);
        }

        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .container {
            flex: 1;
            padding: 2rem;
            display: grid;
            grid-template-columns: minmax(320px, 1fr) 2fr;
            gap: 2rem;
            align-items: start;
        }
        
        #authSection {
            grid-column: 1 / -1;  /* Auth section spans full width */
        }

        .upload-area {
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-area.collapsed {
            padding: 1rem;
            max-width: 100%;
        }
        
        .upload-area.collapsed .upload-title,
        .upload-area.collapsed .upload-subtitle,
        .upload-area.collapsed .rate-limits {
            display: none;
        }
        
        .upload-area.collapsed .drop-zone {
            margin: 0;
            padding: 0.75rem;
            min-height: auto;
            display: flex;
            flex-direction: row;
            gap: 1rem;
            background: var(--surface-hover);
        }
        
        .upload-area.collapsed .drop-zone-icon {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .file-info-compact {
            display: none;
            flex: 1;
            text-align: left;
            min-width: 0; /* Allow flex item to shrink below content width */
            overflow: hidden;
        }
        
        .file-info-compact strong {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .file-info-compact small {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .upload-area.collapsed .file-info-compact {
            display: block;
        }
        
        .change-file-btn {
            display: none;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .upload-area.collapsed .change-file-btn {
            display: block;
        }

        .upload-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .upload-subtitle {
            margin-bottom: 1rem;
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .drop-zone {
            padding: 2rem;
            margin: 1.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        
        .drop-zone p, .drop-zone strong {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .drop-zone small {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .drop-zone.compact {
            padding: 1.5rem;
            min-height: 100px;
            margin: 1rem 0;
        }

        .drop-zone.compact .drop-zone-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .drop-zone-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .drop-zone p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .drop-zone small {
            opacity: 0.7;
        }

        .file-input {
            display: none;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
            transition: all 0.3s ease;
        }
        
        .upload-area.collapsed .actions {
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .action-card {
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
            background: var(--surface-hover);
        }
        
        .upload-area.collapsed .action-card {
            padding: 0.75rem;
            text-align: center;
        }
        
        .upload-area.collapsed .action-card h3 {
            font-size: 0.9rem;
        }
        
        .upload-area.collapsed .action-card p {
            display: none;
        }

        .action-card h3 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-card p {
            font-size: 0.85rem;
            opacity: 0.7;
            line-height: 1.3;
        }

        .rate-limits {
            margin-top: 2rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .rate-limits h4 {
            margin-bottom: 0.5rem;
        }

        .rate-limits .limits {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
        }

        .limit-item {
            text-align: center;
        }

        .limit-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .limit-label {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .processing {
            display: none;
            padding: 2rem;
            text-align: center;
        }

        /* Intelligence Card Styles */
        .intelligence-card {
            margin: 1.5rem 0;
            padding: 1.5rem;
            border-radius: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease;
        }

        .intelligence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .intelligence-header h3 {
            margin: 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .intelligence-refresh {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .intelligence-refresh:hover {
            background: var(--surface-hover);
            color: var(--primary);
        }

        .intelligence-loading {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-secondary);
        }

        .spinner-small {
            width: 20px;
            height: 20px;
            border: 2px solid var(--surface-hover);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .intelligence-summary {
            background: var(--background);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .intelligence-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .badge-critical {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .intelligence-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .insight-card {
            background: var(--background);
            padding: 1rem;
            border-radius: 8px;
            text-align: left;
        }

        .insight-card h5 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-list li {
            padding: 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .completeness-bar {
            width: 100%;
            height: 8px;
            background: var(--surface-hover);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .completeness-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.5s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal spinner */
        .modal-loading .spinner {
            border-color: var(--border);
            border-top-color: var(--accent);
        }

        .results {
            display: none;
            padding: 1.5rem;
            margin-top: 1rem;
            transition: all 0.3s ease;
            max-height: 50vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .results.visible {
            display: flex;
        }

        .results h3 {
            margin-bottom: 1rem;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .copy-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .copy-btn:hover {
            background: var(--surface-hover);
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .result-content {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
            text-align: left;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 200px;
        }

        .result-content:hover {
            background: var(--surface-hover);
        }

        .result-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--font-family-mono, 'Monaco', 'Menlo', 'Ubuntu Mono', monospace);
            font-size: 13px;
            line-height: 1.4;
        }

        .copy-tooltip {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.75rem;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .result-content:hover .copy-tooltip {
            opacity: 1;
        }

        .error-message {
            display: none;
            padding: 1rem;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auth-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
        }

        .auth-card {
            padding: 3rem;
            max-width: 500px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .auth-card h1 {
            margin-bottom: 1rem;
        }

        .auth-card > p {
            margin-bottom: 2rem;
            opacity: 0.7;
        }

        .google-signin-btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .auth-info {
            text-align: left;
            padding: 1.5rem;
            margin-top: 2rem;
            transition: all 0.3s ease;
        }

        .auth-info ul {
            margin: 0.5rem 0 0 1.5rem;
            opacity: 0.7;
        }

        /* Default to Brutalist theme */
        body {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Responsive layout for larger screens */
        @media (min-width: 900px) {
            .container {
                max-width: 1200px;
                margin: 0 auto;
                display: grid !important;
                grid-template-columns: minmax(320px, 1fr) 2fr;  /* Narrower dropzone, wider results area */
                gap: 2rem;
                align-items: start;
            }
            
            #authSection {
                grid-column: 1 / -1;  /* Auth section spans full width */
            }
            
            .upload-area {
                max-width: none;
                min-width: 320px;  /* Smaller minimum width for dropzone */
            }
            
            .results {
                margin-top: 0;
                max-height: 70vh;
            }
            
            .upload-area.collapsed {
                grid-column: 1 / -1;
            }
            
            .upload-area.collapsed + .results {
                grid-column: 1 / -1;
                max-height: 60vh;
            }
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            flex-shrink: 0;
            background: var(--background);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            /* Hide by default on mobile */
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            position: relative;
            height: calc(100vh - 60px); /* Full viewport height minus header */
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
        }
        
        .sidebar-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .sidebar-toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text);
        }
        
        .sidebar-toggle-btn:hover {
            background: var(--surface-hover);
        }
        
        .sidebar.open .sidebar-toggle-btn i {
            transform: rotate(0deg);
        }
        
        .sidebar:not(.open) .sidebar-toggle-btn i {
            transform: rotate(180deg);
        }
        
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: 60px; /* Space for fixed Clear History button */
        }
        
        .sidebar-search {
            position: relative;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .sidebar-search svg {
            position: absolute;
            left: 1.8rem; /* Positioned to be centered in the input's left padding */
            top: 1.8rem; /* Position inside the input field */
            opacity: 0.5;
            z-index: 1;
            pointer-events: none;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--background);
        }
        
        .recent-files-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .no-recent-files {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            text-align: center;
            opacity: 0.6;
        }
        
        .no-recent-files p {
            margin: 0.5rem 0 0.25rem 0;
            font-weight: 500;
        }
        
        .no-recent-files small {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .recent-file-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            display: block;
            text-decoration: none;
            color: inherit;
        }
        
        .recent-file-item:hover {
            background: var(--surface-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .recent-file-item.hidden {
            display: none;
        }
        
        .recent-file-name {
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .recent-file-time {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-bottom: 0.5rem;
        }
        
        .recent-file-actions {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .recent-file-action {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .recent-file-action i,
        .recent-file-action svg {
            color: white !important;
            stroke: white !important;
        }
        
        .recent-file-action:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }
        
        .sidebar-actions {
            padding: 1rem;
            border-top: 1px solid var(--border);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            z-index: 5;
        }
        
        .clear-history-btn {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .clear-history-btn:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }
        
        /* Mobile Sidebar Toggle */
        .mobile-sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 101;
            background: var(--accent);
            color: var(--accent-text);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        
        .mobile-sidebar-toggle:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
        }
        
        /* Main content adjustments for sidebar */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
        }

        /* Results area - always visible */
        .results-area {
            padding: 0;
            background: var(--surface);
            border-top: 2px solid var(--border);
            min-height: 200px;
            border-radius: 8px 8px 0 0;
        }

        .results-area h3 {
            margin: 0;
            padding: 2rem 2rem 1rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .results-placeholder {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            border: 1px dashed var(--border);
            border-radius: 0;
            background: rgba(0, 0, 0, 0.01);
            margin: 0;
        }

        .results-placeholder i {
            display: block;
            margin: 0 auto 0.75rem auto;
        }

        .results-placeholder p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Hide results div by default */
        .results {
            display: none;
        }

        /* When results are populated */
        .results-area.has-results {
            background: var(--background);
            border-top-color: var(--accent);
        }

        .results-area.has-results .results-placeholder {
            display: none;
        }

        .results-area.has-results .results {
            display: block;
        }
        
        /* Extra wide screens get even better proportions */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
                grid-template-columns: minmax(350px, 1fr) 3fr !important;  /* Even narrower dropzone on very wide screens */
                gap: 2.5rem;
            }
        }
        
        /* Responsive behavior */
        @media (max-width: 768px) {
            .app-layout {
                position: relative;
            }
            
            /* Hide header toggle on mobile, show mobile floating button */
            .header-sidebar-toggle {
                display: none !important;
            }
            
            .mobile-sidebar-toggle {
                display: flex !important;
            }
            
            .sidebar {
                position: absolute;
                width: 280px;
                height: 100%;
                z-index: 100;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }
            .mobile-sidebar-toggle {
                display: flex;
            }
            
            .sidebar.open {
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            }

            .results-area {
                padding: 1.5rem;
                min-height: 150px;
            }

            .results-placeholder {
                padding: 1rem;
            }
            
            /* Overlay for mobile */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .sidebar-overlay.show {
                display: block;
                opacity: 1;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar {
                transform: translateX(0); /* Show sidebar by default on desktop */
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            /* Hide mobile toggle on desktop - we use header toggle instead */
            .mobile-sidebar-toggle {
                display: none !important;
            }
            
            /* Show header toggle on desktop */
            .header-sidebar-toggle {
                display: flex;
            }
        }
        
        /* Sidebar animations */
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }
        
        .recent-file-item {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-large {
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            color: var(--text);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--surface-hover);
            color: var(--error);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .form-field {
            margin-bottom: 1.5rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .field-type {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-left: 0.5rem;
            padding: 0.125rem 0.375rem;
            background: var(--surface-hover);
            border-radius: 3px;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            color: var(--text);
            font-family: inherit;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-field input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        .form-field input[type="file"] {
            padding: 0.375rem;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
        }

        .file-selector {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .file-selector input {
            flex: 1;
        }

        .file-selector button {
            padding: 0.75rem 1rem;
            white-space: nowrap;
        }

        .progress-container {
            background: var(--surface-hover);
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 3px solid var(--accent);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--surface);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .results-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .result-stat {
            text-align: center;
            padding: 0.75rem;
            background: var(--surface-hover);
            border-radius: 4px;
        }

        .result-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .result-stat-label {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .error-list {
            max-height: 150px;
            overflow-y: auto;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .error-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .error-row {
            font-weight: 500;
            color: var(--error);
        }

        .error-message {
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .naming-pattern-help {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        .bulk-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .bulk-actions .btn-secondary {
            flex: 1;
        }

        .modal-loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .modal-loading .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 1rem;
        }

        .password-section {
            background: var(--surface-hover);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--warning);
        }

        .password-section h4 {
            margin-bottom: 0.5rem;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }
        .theme-mono .icon-btn:hover svg

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
        }

        /* Theme-specific modal styles */
        .theme-brutalist .modal {
            border-radius: 0;
            border: 2px solid var(--border);
            box-shadow: none;
        }

        .theme-brutalist .modal-header,
        .theme-brutalist .modal-footer {
            border-color: var(--border);
        }

        .theme-brutalist .form-field input,
        .theme-brutalist .form-field select,
        .theme-brutalist .form-field textarea {
            border-radius: 0;
            border: 2px solid var(--border);
        }

        .theme-brutalist .btn-primary {
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 2px solid var(--border);
        }

        .theme-brutalist .btn-secondary {
            border-radius: 0;
            border: 2px solid var(--border);
        }

        .theme-glassmorphic .modal {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
        }

        .theme-glassmorphic .form-field input,
        .theme-glassmorphic .form-field select,
        .theme-glassmorphic .form-field textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .theme-neubrutalism .modal {
            border-radius: 0;
            border: 4px solid var(--border);
            box-shadow: 8px 8px 0 var(--border);
        }

        .theme-neubrutalism .form-field input,
        .theme-neubrutalism .form-field select,
        .theme-neubrutalism .form-field textarea {
            border-radius: 0;
            border: 3px solid var(--border);
        }

        .theme-neubrutalism .btn-primary {
            border-radius: 0;
            border: 3px solid var(--border);
            box-shadow: 4px 4px 0 var(--border);
            text-transform: uppercase;
            font-weight: 700;
        }

        .theme-neubrutalism .btn-primary:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--border);
        }

        .theme-mono .modal {
            border-radius: 0;
            border: 1px solid var(--border);
        }

        /* Profile-specific styles */
        .profile-item {
            padding: 1.25rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: var(--surface);
            transition: all 0.2s ease;
        }

        .profile-item:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
        }

        .profile-item.default {
            border-color: var(--primary);
            background: var(--primary-bg);
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .profile-name .default-badge {
            background: var(--primary);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .profile-description {
            opacity: 0.8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .profile-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .profile-tag {
            background: var(--surface-hover);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .profile-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            opacity: 0.6;
            margin-bottom: 0.75rem;
        }

        .profile-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .profile-actions .icon-btn {
            width: 28px;
            height: 28px;
            font-size: 14px;
        }

        .profile-fields-preview {
            background: var(--surface-hover);
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .empty-profiles {
            text-align: center;
            padding: 3rem 2rem;
            opacity: 0.6;
        }

        .empty-profiles i {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .form-field {
            margin-bottom: 1.5rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-field input,
        .form-field textarea,
        .form-field select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--surface);
            color: var(--text);
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-field input:focus,
        .form-field textarea:focus,
        .form-field select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .profile-field {
            margin-bottom: 1rem;
        }

        .profile-field label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .profile-field input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--surface);
            color: var(--text);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .theme-mono .form-field input,
        .theme-mono .form-field select,
        .theme-mono .form-field textarea {
            border-radius: 0;
            border: 1px solid var(--border);
        }

        .theme-mono .btn-primary,
        .theme-mono .btn-secondary {
            border-radius: 0;
        }

        /* Compact mode for medium screens */
        @media (max-width: 600px) {
            .upload-area {
                padding: 1rem;
            }
            
            .actions {
                grid-template-columns: 1fr;
            }
            
            .upload-area.collapsed .actions {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .action-card {
                padding: 1rem;
            }

            .modal {
                width: 95%;
                margin: 1rem;
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="theme-brutalist">
    <!-- Header should be FIRST and FULL WIDTH -->
    <header class="header">
        <div style="display: flex; align-items: center;">
            <button class="header-sidebar-toggle" id="headerSidebarToggle" aria-label="Toggle sidebar">
                <i data-lucide="panel-left-close" style="width: 20px; height: 20px;"></i>
            </button>
            <h1>
                <div class="logo-icon">
                    <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
                </div>
                <span>PDF Filler</span>
            </h1>
        </div>
        <div class="header-controls">
            <div class="status">
                <div class="account-dropdown">
                    <div class="account-trigger" id="accountTrigger">
                        <span class="status-dot" id="geminiStatus"></span>
                        <span id="geminiStatusText">Checking...</span>
                        <span style="font-size: 0.75rem;">▼</span>
                    </div>
                    <div class="account-menu" id="accountMenu">
                        <div class="account-menu-item" id="accountEmail" style="font-weight: 500; border-bottom: 1px solid var(--border);">
                            <!-- Email will be inserted here -->
                        </div>
                        <button class="account-menu-item" onclick="signOut()">
                            <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
                            <span>Sign Out</span>
                        </button>
                        <button class="account-menu-item" onclick="switchAccount()">
                            <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                            <span>Switch Account</span>
                        </button>
                    </div>
                </div>
                <div class="status-indicator">
                    <span>Free Tier</span>
                </div>
            </div>
            <button class="icon-btn" id="settingsBtn" onclick="toggleSettings()" title="Settings">
                <span style="font-size: 18px; line-height: 1;">⚙</span>
            </button>
        </div>
    </header>

    <!-- App container with sidebar and main -->
    <div class="app-layout">
        <!-- Sidebar on LEFT -->
        <!-- Recent Files Sidebar -->
        <aside class="sidebar" id="recentFilesSidebar">
        <div class="sidebar-header">
            <h3><i data-lucide="clock" style="width: 18px; height: 18px;"></i> Recent Files</h3>
            <button class="sidebar-toggle-btn" id="sidebarToggle" aria-label="Toggle sidebar">
                <i data-lucide="menu" style="width: 18px; height: 18px;"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-search">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                <input type="text" id="recentFilesSearch" placeholder="Search files..." class="search-input">
            </div>
            <div class="recent-files-list" id="recentFilesList">
                <div class="no-recent-files">
                    <i data-lucide="file-text" style="width: 32px; height: 32px; opacity: 0.3;"></i>
                    <p>No recent files</p>
                    <small>Upload a PDF to get started</small>
                </div>
            </div>
        </div>
        <div class="sidebar-actions">
            <button class="clear-history-btn" id="clearRecentFiles">
                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                Clear History
            </button>
        </div>
        </aside>

        <!-- Main content on RIGHT -->
        <main class="main-content">
        <div class="container">
            <!-- Auth Section -->
        <div id="authSection" class="auth-section" style="display: none;">
            <div class="auth-card">
                <h1>Welcome to PDF Filler</h1>
                <p>Sign in with your Google account to start processing PDFs for free</p>
                
                <button id="googleSignIn" class="google-signin-btn" onclick="handleGoogleSignIn()">
                    <svg width="20" height="20" viewBox="0 0 48 48" style="margin-right: 8px;">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    </svg>
                    Sign in with Google
                </button>
                
                <div class="auth-info">
                    <p><strong>✨ Completely Free</strong></p>
                    <p>Using Google's generous Gemini free tier:</p>
                    <ul>
                        <li>60 requests per minute</li>
                        <li>1,000 requests per day</li>
                        <li>1M token context window</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Settings View -->
        <div class="settings-view" id="settingsView">
            <div class="settings-header">
                <button class="icon-btn" onclick="toggleSettings()" style="display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 18px; line-height: 0; display: inline-block; transform: translateY(1px);">←</span>
                </button>
                <h2>Settings</h2>
            </div>
            
            <div class="settings-section">
                <h3><i data-lucide="palette" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Theme</h3>
                <div class="theme-grid">
                    <div class="theme-card" data-theme="brutalist" onclick="selectTheme('brutalist')">
                        <div class="theme-preview" style="background: #000; color: #0F0;">[ ]</div>
                        <h4>Brutalist Mono</h4>
                        <small>Terminal-inspired design</small>
                    </div>
                    <div class="theme-card" data-theme="glassmorphic" onclick="selectTheme('glassmorphic')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white;">◈</div>
                        <h4>Glassmorphic</h4>
                        <small>Modern transparency</small>
                    </div>
                    <div class="theme-card" data-theme="neubrutalism" onclick="selectTheme('neubrutalism')">
                        <div class="theme-preview" style="background: #FF0080; color: white;">■</div>
                        <h4>Neubrutalism</h4>
                        <small>Bold and playful</small>
                    </div>
                    <div class="theme-card" data-theme="gruvbox" onclick="selectTheme('gruvbox')">
                        <div class="theme-preview" style="background: #fbf1c7; color: #282828; border: 2px solid #d5c4a1;">
                            <i data-lucide="sun" style="width: 24px; height: 24px;"></i>
                        </div>
                        <h4>Gruvbox Light</h4>
                        <small>Warm retro comfort</small>
                    </div>
                    <div class="theme-card" data-theme="mono" onclick="selectTheme('mono')">
                        <div class="theme-preview" style="background: #FFFFFF; color: #000000; border: 1px solid #000000;">
                            <i data-lucide="square" style="width: 24px; height: 24px;"></i>
                        </div>
                        <h4>Mono</h4>
                        <small>Minimal with Geist</small>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3><i data-lucide="bar-chart-2" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Usage Limits</h3>
                <p>You're using Google's generous free tier:</p>
                <ul style="margin-left: 1.5rem; opacity: 0.8;">
                    <li>60 requests per minute</li>
                    <li>1,000 requests per day</li>
                    <li>1M token context window</li>
                </ul>
            </div>
            
            <div class="settings-section">
                <h3><i data-lucide="info" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> About</h3>
                <p style="opacity: 0.8;">PDF Filler v1.0.0<br>
                Created by Mat Silverstein<br>
                Powered by Google Gemini AI</p>
            </div>
        </div>
        
        <div class="upload-area" id="mainApp" style="display: none;">
            <h2 class="upload-title">AI-Powered PDF Processing</h2>
            <p class="upload-subtitle">Powered by Google Gemini's free tier</p>

            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">
                    <i data-lucide="upload" style="width: 48px; height: 48px;"></i>
                </div>
                <p>Drag your PDF here</p>
                <small>or click to browse</small>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
            </div>

            <!-- Intelligence Card -->
            <div class="intelligence-card" id="intelligenceCard" style="display: none;">
                <div class="intelligence-header">
                    <h3>
                        <i data-lucide="sparkles" style="width: 20px; height: 20px;"></i>
                        Document Intelligence
                    </h3>
                    <button class="intelligence-refresh" onclick="refreshIntelligence()">
                        <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
                <div class="intelligence-content" id="intelligenceContent">
                    <div class="intelligence-loading">
                        <div class="spinner-small"></div>
                        <span>Analyzing document...</span>
                    </div>
                </div>
            </div>

            <div class="rate-limits">
                <h4><i data-lucide="activity" style="width: 18px; height: 18px; display: inline-block; vertical-align: text-bottom;"></i> Usage Limits (Free Tier)</h4>
                <div class="limits">
                    <div class="limit-item">
                        <div class="limit-value" id="minuteLimit">60</div>
                        <div class="limit-label">per minute</div>
                    </div>
                    <div class="limit-item">
                        <div class="limit-value" id="dayLimit">1000</div>
                        <div class="limit-label">per day</div>
                    </div>
                    <div class="limit-item">
                        <div class="limit-value">1M</div>
                        <div class="limit-label">token context</div>
                    </div>
                </div>
            </div>

            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p id="processingText">Processing with Gemini AI...</p>
                <small style="display: block; margin-top: 10px;">
                    This may take 30-60 seconds for complex PDFs
                </small>
                <div id="processingTimer" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>

            <div class="results" id="results">
                <div class="result-header">
                    <h3>Results</h3>
                    <button class="copy-btn" id="copyBtn" onclick="copyToClipboard()">
                        <i id="copyIcon" data-lucide="clipboard" style="width: 16px; height: 16px;"></i>
                        <span id="copyText">Copy JSON</span>
                    </button>
                </div>
                <div class="result-content" id="resultContent" onclick="copyToClipboard()">
                    <span class="copy-tooltip">Click to copy</span>
                </div>
                <button onclick="downloadResult()" style="margin-top: 1rem;">Download Result</button>
            </div>

            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- Results area - ALWAYS VISIBLE (moved outside upload-area to be a grid sibling) -->
        <div class="results-area" id="resultsSection">
            <!-- Actions moved here from upload-area -->
            <div class="actions">
                <div class="action-card" data-action="analyze">
                    <h3><i data-lucide="search" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Analyze</h3>
                    <p>Extract structure and form fields</p>
                </div>
                <div class="action-card" data-action="extract">
                    <h3><i data-lucide="database" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Extract Data</h3>
                    <p>Convert PDF content to JSON</p>
                </div>
                <div class="action-card" data-action="fill">
                    <h3><i data-lucide="pen-tool" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Fill Form</h3>
                    <p>Auto-fill PDF forms with data</p>
                </div>
                <div class="action-card" data-action="bulk-fill">
                    <h3><i data-lucide="layers" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Bulk Fill</h3>
                    <p>Fill multiple forms with CSV data</p>
                </div>
                <div class="action-card" data-action="validate">
                    <h3><i data-lucide="check-circle" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Validate</h3>
                    <p>Check required fields</p>
                </div>
                <div class="action-card" data-action="profiles">
                    <h3><i data-lucide="user" style="width: 20px; height: 20px; display: inline-block; vertical-align: text-bottom;"></i> Profiles</h3>
                    <p>Manage saved form data</p>
                </div>
            </div>
            
            <h3 style="margin-top: 2rem;">Analysis Results</h3>
            <div class="results-placeholder">
                <i data-lucide="file-search" style="width: 32px; height: 32px; opacity: 0.3;"></i>
                <p>Upload and analyze a PDF to see results</p>
            </div>
        </div>
        </main>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle" aria-label="Toggle recent files">
        <i data-lucide="menu" style="width: 20px; height: 20px;"></i>
    </button>
    
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Form Fill Modal -->
    <div class="modal-overlay" id="formFillModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="pen-tool" style="width: 20px; height: 20px;"></i>
                    Fill PDF Form
                </h3>
                <button class="modal-close" onclick="closeFormFillModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Password section (shown if PDF is protected) -->
                <div class="password-section" id="passwordSection" style="display: none;">
                    <h4>
                        <i data-lucide="lock" style="width: 16px; height: 16px;"></i>
                        Password Protected PDF
                    </h4>
                    <p>This PDF requires a password to access form fields.</p>
                    <div class="form-field">
                        <label for="pdfPassword">PDF Password</label>
                        <input type="password" id="pdfPassword" placeholder="Enter PDF password">
                        <button type="button" onclick="submitPassword()" style="margin-top: 0.5rem;" class="btn-primary">
                            <i data-lucide="unlock" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                            Unlock PDF
                        </button>
                    </div>
                </div>

                <!-- Loading state -->
                <div class="modal-loading" id="modalLoading">
                    <div class="spinner"></div>
                    <p>Reading form fields...</p>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" style="display: none; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                        <select id="profileSelect" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
                            <option value="">Select a profile...</option>
                        </select>
                        <button class="btn-secondary" id="loadProfileBtn" onclick="loadSelectedProfile()" disabled>
                            <i data-lucide="upload" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                            Load
                        </button>
                        <button class="btn-secondary" id="saveAsProfileBtn" onclick="openSaveProfileModal()">
                            <i data-lucide="save" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                            Save as Profile
                        </button>
                    </div>
                </div>

                <!-- Form fields container -->
                <div id="formFieldsContainer" style="display: none;">
                    <p style="margin-bottom: 1.5rem; opacity: 0.8;">Fill in the form fields below. Leave fields empty to keep their current values.</p>
                    <div id="formFields"></div>
                </div>

                <!-- Error message -->
                <div id="modalError" style="display: none; color: var(--error); padding: 1rem; background: var(--surface-hover); border-radius: 4px; margin-bottom: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeFormFillModal()">Cancel</button>
                <button class="btn-primary" id="fillFormBtn" onclick="fillAndSavePDF()" disabled>
                    <i data-lucide="download" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                    Fill & Save PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Management Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="user" style="width: 20px; height: 20px;"></i>
                    Profile Manager
                </h3>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Profile List Section -->
                <div id="profileListSection">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="list" style="width: 18px; height: 18px;"></i>
                            Saved Profiles
                        </h4>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn-secondary" onclick="exportProfiles()">
                                <i data-lucide="download" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                                Export
                            </button>
                            <button class="btn-secondary" onclick="importProfiles()">
                                <i data-lucide="upload" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                                Import
                            </button>
                            <button class="btn-primary" onclick="openCreateProfileModal()">
                                <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                                New Profile
                            </button>
                        </div>
                    </div>
                    
                    <div id="profileList" style="max-height: 400px; overflow-y: auto;">
                        <div class="loading-profiles" style="text-align: center; padding: 2rem; opacity: 0.6;">
                            <i data-lucide="loader-2" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i>
                            <p style="margin-top: 0.5rem;">Loading profiles...</p>
                        </div>
                    </div>
                </div>

                <div id="profileModalError" style="display: none; color: var(--error); padding: 1rem; background: var(--surface-hover); border-radius: 4px; margin-top: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeProfileModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Save Profile Modal -->
    <div class="modal-overlay" id="saveProfileModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="save" style="width: 20px; height: 20px;"></i>
                    Save Profile
                </h3>
                <button class="modal-close" onclick="closeSaveProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label for="profileName">Profile Name *</label>
                    <input type="text" id="profileName" placeholder="e.g., Personal Info, Company Details" required>
                </div>
                <div class="form-field">
                    <label for="profileDescription">Description</label>
                    <textarea id="profileDescription" placeholder="Brief description of this profile..." rows="3"></textarea>
                </div>
                <div class="form-field">
                    <label for="profileTags">Tags (comma-separated)</label>
                    <input type="text" id="profileTags" placeholder="e.g., personal, work, address">
                </div>
                <div class="form-field">
                    <label>
                        <input type="checkbox" id="setAsDefault" style="margin-right: 0.5rem;">
                        Set as default profile
                    </label>
                </div>
                <div id="saveProfileError" style="display: none; color: var(--error); padding: 1rem; background: var(--surface-hover); border-radius: 4px; margin-top: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeSaveProfileModal()">Cancel</button>
                <button class="btn-primary" id="saveProfileBtn" onclick="saveProfile()">
                    <i data-lucide="save" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                    Save Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Profile Modal -->
    <div class="modal-overlay" id="createProfileModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title" id="createProfileTitle">
                    <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
                    Create New Profile
                </h3>
                <button class="modal-close" onclick="closeCreateProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div>
                        <div class="form-field">
                            <label for="createProfileName">Profile Name *</label>
                            <input type="text" id="createProfileName" placeholder="e.g., Personal Info" required>
                        </div>
                        <div class="form-field">
                            <label for="createProfileDescription">Description</label>
                            <textarea id="createProfileDescription" placeholder="Brief description..." rows="2"></textarea>
                        </div>
                        <div class="form-field">
                            <label for="createProfileTags">Tags (comma-separated)</label>
                            <input type="text" id="createProfileTags" placeholder="e.g., personal, work">
                        </div>
                        <div class="form-field">
                            <label>
                                <input type="checkbox" id="createSetAsDefault" style="margin-right: 0.5rem;">
                                Set as default profile
                            </label>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="edit-3" style="width: 18px; height: 18px;"></i>
                            Profile Data
                        </h4>
                        <div id="createProfileFields" style="max-height: 300px; overflow-y: auto; padding: 1rem; background: var(--surface-hover); border-radius: 4px;">
                            <p style="opacity: 0.6; text-align: center;">Common form fields will appear here</p>
                        </div>
                    </div>
                </div>
                <div id="createProfileError" style="display: none; color: var(--error); padding: 1rem; background: var(--surface-hover); border-radius: 4px; margin-top: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCreateProfileModal()">Cancel</button>
                <button class="btn-primary" id="createProfileBtn" onclick="createProfile()">
                    <i data-lucide="save" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                    <span id="createProfileBtnText">Create Profile</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for profile import -->
    <input type="file" id="profileImportInput" accept=".json" style="display: none;">

    <!-- Bulk Fill Modal -->
    <div class="modal-overlay" id="bulkFillModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="layers" style="width: 20px; height: 20px;"></i>
                    Bulk Fill PDFs
                </h3>
                <button class="modal-close" onclick="closeBulkFillModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Setup Section -->
                <div id="bulkSetupSection">
                    <p style="margin-bottom: 1.5rem; opacity: 0.8;">Fill multiple PDFs using data from a CSV file. Each row in the CSV will create a filled PDF.</p>
                    
                    <div class="form-field">
                        <label for="templatePDF">Template PDF</label>
                        <div class="file-selector">
                            <input type="text" id="templatePDF" readonly placeholder="Select your template PDF file...">
                            <button type="button" class="btn-secondary" onclick="selectTemplatePDF()">
                                <i data-lucide="file-plus" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                                Browse
                            </button>
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="csvFile">CSV Data File</label>
                        <div class="file-selector">
                            <input type="text" id="csvFile" readonly placeholder="Select your CSV data file...">
                            <button type="button" class="btn-secondary" onclick="selectCSVFile()">
                                <i data-lucide="table" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                                Browse
                            </button>
                        </div>
                        <small style="opacity: 0.7; margin-top: 0.25rem; display: block;">CSV should have column headers matching form field names</small>
                    </div>

                    <div class="form-field">
                        <label for="outputDirectory">Output Directory</label>
                        <div class="file-selector">
                            <input type="text" id="outputDirectory" readonly placeholder="Select where to save filled PDFs...">
                            <button type="button" class="btn-secondary" onclick="selectOutputDirectory()">
                                <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                                Browse
                            </button>
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="namingPattern">File Naming Pattern</label>
                        <input type="text" id="namingPattern" placeholder="filled_{row}_{timestamp}" value="filled_{row}_{timestamp}">
                        <div class="naming-pattern-help">
                            Available variables:<br>
                            • <code>{row}</code> - Row number (1, 2, 3...)<br>
                            • <code>{timestamp}</code> - Current timestamp<br>
                            • <code>{column_name}</code> - Any CSV column value (e.g., {name}, {id})
                        </div>
                    </div>

                    <!-- Password section (shown if template PDF is protected) -->
                    <div class="password-section" id="bulkPasswordSection" style="display: none;">
                        <h4>
                            <i data-lucide="lock" style="width: 16px; height: 16px;"></i>
                            Password Protected PDF
                        </h4>
                        <p>This template PDF requires a password to access form fields.</p>
                        <div class="form-field">
                            <label for="bulkPdfPassword">PDF Password</label>
                            <input type="password" id="bulkPdfPassword" placeholder="Enter PDF password">
                        </div>
                    </div>
                </div>

                <!-- Processing Section -->
                <div id="bulkProcessingSection" style="display: none;">
                    <div class="progress-container">
                        <div class="progress-text" id="bulkProgressText">Preparing to process files...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bulkProgressFill"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; opacity: 0.8;">
                            <span id="bulkProgressCount">0 / 0</span>
                            <span id="bulkProgressPercent">0%</span>
                        </div>
                    </div>

                    <div class="results-summary" id="bulkResultsSummary" style="display: none;">
                        <div class="result-stat">
                            <div class="result-stat-value" id="successCount">0</div>
                            <div class="result-stat-label">Successful</div>
                        </div>
                        <div class="result-stat">
                            <div class="result-stat-value" id="failureCount">0</div>
                            <div class="result-stat-label">Failed</div>
                        </div>
                    </div>

                    <div id="bulkErrorContainer" style="display: none;">
                        <h4 style="margin: 1rem 0 0.5rem 0; color: var(--error);">Errors</h4>
                        <div class="error-list" id="bulkErrorList"></div>
                    </div>
                </div>

                <!-- Error message -->
                <div id="bulkModalError" style="display: none; color: var(--error); padding: 1rem; background: var(--surface-hover); border-radius: 4px; margin-bottom: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <div class="bulk-actions">
                    <button class="btn-secondary" onclick="closeBulkFillModal()">Cancel</button>
                    <button class="btn-secondary" id="downloadSummaryBtn" onclick="downloadBulkSummary()" style="display: none;">
                        <i data-lucide="download" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                        Download Summary
                    </button>
                    <button class="btn-primary" id="startBulkFillBtn" onclick="startBulkFill()" disabled>
                        <i data-lucide="play" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                        Start Processing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let selectedFileIsPath = false; // Track if selectedFile is a path or File object
        let currentResult = null;
        let isAuthenticated = false;
        let currentTheme = localStorage.getItem('selectedTheme') || 'brutalist';
        let currentFormFields = null;
        let currentModalFile = null;

        // Toggle between main app and settings
        function toggleSettings() {
            const settingsView = document.getElementById('settingsView');
            const mainApp = document.getElementById('mainApp');
            const authSection = document.getElementById('authSection');
            
            if (settingsView.style.display === 'block') {
                // Go back to main app
                settingsView.style.display = 'none';
                if (isAuthenticated) {
                    mainApp.style.display = 'block';
                } else {
                    authSection.style.display = 'block';
                }
            } else {
                // Show settings
                settingsView.style.display = 'block';
                mainApp.style.display = 'none';
                authSection.style.display = 'none';
                updateThemeCards();
            }
            
            // Refresh icons
            setTimeout(() => lucide.createIcons(), 10);
        }

        // Update active theme card
        function updateThemeCards() {
            document.querySelectorAll('.theme-card').forEach(card => {
                if (card.dataset.theme === currentTheme) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        }

        // Select theme from settings
        function selectTheme(themeName) {
            applyTheme(themeName);
            updateThemeCards();
            lucide.createIcons();
        }

        // Apply saved theme on load
        function applyTheme(themeName) {
            document.body.className = `theme-${themeName}`;
            currentTheme = themeName;
            localStorage.setItem('selectedTheme', themeName);
            
            // Apply theme-specific styles dynamically
            updateThemeStyles(themeName);
        }

        function updateThemeStyles(themeName) {
            const header = document.querySelector('.header');
            const uploadArea = document.querySelector('.upload-area');
            const dropZone = document.querySelector('.drop-zone');
            const actionCards = document.querySelectorAll('.action-card');
            const authCard = document.querySelector('.auth-card');
            const statusIndicators = document.querySelectorAll('.status-indicator');
            const rateLimits = document.querySelector('.rate-limits');
            const results = document.querySelector('.results');
            const errorMessage = document.querySelector('.error-message');
            const statusDot = document.querySelector('.status-dot');
            const logoIcon = document.querySelector('.logo-icon');
            
            // Reset all custom styles
            const elements = [header, uploadArea, dropZone, authCard, rateLimits, results, errorMessage, logoIcon, ...actionCards, ...statusIndicators];
            elements.forEach(el => {
                if (el) el.style = '';
            });

            switch(themeName) {
                case 'brutalist':
                    document.body.style.background = 'var(--bg)';
                    if (header) {
                        header.style.borderBottom = '1px solid var(--border)';
                        header.style.background = 'var(--surface)';
                    }
                    if (uploadArea) {
                        uploadArea.style.background = 'var(--surface)';
                        uploadArea.style.border = '1px solid var(--border)';
                        uploadArea.style.borderRadius = '0';
                    }
                    if (dropZone) {
                        dropZone.style.border = '2px dashed var(--border)';
                        dropZone.style.borderRadius = '0';
                    }
                    actionCards.forEach(card => {
                        card.style.border = '1px solid var(--border)';
                        card.style.borderRadius = '0';
                        card.style.background = 'var(--surface)';
                    });
                    if (statusDot) statusDot.style.background = 'var(--success)';
                    break;


                case 'glassmorphic':
                    document.body.style.background = '#0A0E1A';
                    if (header) {
                        header.style.background = 'rgba(17, 24, 39, 0.5)';
                        header.style.backdropFilter = 'blur(20px) saturate(180%)';
                        header.style.border = '1px solid rgba(255, 255, 255, 0.08)';
                    }
                    if (uploadArea) {
                        uploadArea.style.background = 'rgba(255, 255, 255, 0.03)';
                        uploadArea.style.backdropFilter = 'blur(20px) saturate(180%)';
                        uploadArea.style.border = '1px solid rgba(255, 255, 255, 0.08)';
                        uploadArea.style.borderRadius = '16px';
                        uploadArea.style.boxShadow = '0 20px 40px rgba(0, 0, 0, 0.3)';
                    }
                    if (dropZone) {
                        dropZone.style.background = 'rgba(99, 102, 241, 0.05)';
                        dropZone.style.border = '2px dashed rgba(99, 102, 241, 0.3)';
                        dropZone.style.borderRadius = '12px';
                    }
                    if (logoIcon) {
                        logoIcon.style.background = 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)';
                        logoIcon.style.borderRadius = '8px';
                        logoIcon.style.color = 'white';
                    }
                    actionCards.forEach(card => {
                        card.style.background = 'rgba(255, 255, 255, 0.03)';
                        card.style.backdropFilter = 'blur(20px)';
                        card.style.border = '1px solid rgba(255, 255, 255, 0.08)';
                        card.style.borderRadius = '12px';
                    });
                    statusIndicators.forEach(ind => {
                        ind.style.background = 'rgba(255, 255, 255, 0.05)';
                        ind.style.backdropFilter = 'blur(10px)';
                        ind.style.border = '1px solid rgba(255, 255, 255, 0.08)';
                        ind.style.borderRadius = '100px';
                    });
                    if (statusDot) {
                        statusDot.style.background = '#34D399';
                        statusDot.style.boxShadow = '0 0 8px rgba(52, 211, 153, 0.5)';
                    }
                    break;

                case 'neubrutalism':
                    document.body.style.background = '#FFF8E7';
                    if (header) {
                        header.style.background = 'white';
                        header.style.border = '4px solid #000';
                        header.style.boxShadow = '6px 6px 0 #000';
                        header.style.margin = '1rem';
                    }
                    if (uploadArea) {
                        uploadArea.style.background = 'white';
                        uploadArea.style.border = '4px solid #000';
                        uploadArea.style.borderRadius = '0';
                        uploadArea.style.boxShadow = '8px 8px 0 #000';
                    }
                    if (dropZone) {
                        dropZone.style.border = '4px dashed #000';
                        dropZone.style.borderRadius = '0';
                        dropZone.style.background = 'linear-gradient(45deg, #FFE5F1 25%, transparent 25%, transparent 75%, #FFE5F1 75%, #FFE5F1), linear-gradient(45deg, #FFE5F1 25%, transparent 25%, transparent 75%, #FFE5F1 75%, #FFE5F1)';
                        dropZone.style.backgroundSize = '20px 20px';
                        dropZone.style.backgroundPosition = '0 0, 10px 10px';
                    }
                    if (logoIcon) {
                        logoIcon.style.background = '#FF0080';
                        logoIcon.style.border = '3px solid #000';
                        logoIcon.style.borderRadius = '0';
                        logoIcon.style.color = 'white';
                        logoIcon.style.transform = 'rotate(-5deg)';
                        logoIcon.style.boxShadow = '3px 3px 0 #000';
                    }
                    actionCards.forEach((card, index) => {
                        const colors = ['#FFE5F1', '#E5F1FF', '#FFFBE5', '#E5FFE5'];
                        card.style.background = colors[index % 4];
                        card.style.border = '4px solid #000';
                        card.style.borderRadius = '0';
                        card.style.boxShadow = '5px 5px 0 #000';
                    });
                    statusIndicators.forEach(ind => {
                        ind.style.background = '#FFD700';
                        ind.style.border = '3px solid #000';
                        ind.style.borderRadius = '0';
                        ind.style.boxShadow = '3px 3px 0 #000';
                    });
                    if (statusDot) statusDot.style.background = '#00FF88';
                    break;
                    
                case 'gruvbox':
                    document.body.style.background = 'var(--bg)';
                    // Gruvbox theme uses CSS variables from themes.css
                    // No need for manual style overrides
                    if (statusDot) statusDot.style.background = 'var(--success)';
                    break;
                    
                case 'mono':
                    document.body.style.background = 'var(--bg)';
                    document.body.style.fontFamily = 'var(--font-family)';
                    // Mono themes use CSS variables from themes.css
                    if (statusDot) statusDot.style.background = 'var(--success)';
                    break;
            }
        }

        // Initialize theme
        applyTheme(currentTheme);

        // Check authentication status on load
        async function checkAuthStatus() {
            if (window.electronAPI) {
                const authStatus = await window.electronAPI.checkAuthStatus();
                isAuthenticated = authStatus.authenticated;
                
                if (isAuthenticated) {
                    // Get user email separately if not in authStatus
                    let userEmail = authStatus.email;
                    if (!userEmail || userEmail === 'undefined') {
                        try {
                            userEmail = await window.electronAPI.getUserEmail();
                        } catch {
                            userEmail = 'authenticated';
                        }
                    }
                    
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('geminiStatus').style.background = 'var(--success)';
                    document.getElementById('geminiStatusText').textContent = userEmail || 'Connected';
                    document.getElementById('accountEmail').innerHTML = `<i data-lucide="mail" style="width: 16px; height: 16px;"></i><span>${userEmail || 'Connected'}</span>`;
                    lucide.createIcons();
                } else {
                    document.getElementById('authSection').style.display = 'block';
                    document.getElementById('mainApp').style.display = 'none';
                }
            } else {
                checkGeminiStatus();
            }
        }

        // Account dropdown functionality
        const accountTrigger = document.getElementById('accountTrigger');
        const accountMenu = document.getElementById('accountMenu');

        if (accountTrigger) {
            accountTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                accountMenu.classList.toggle('show');
            });
        }

        document.addEventListener('click', () => {
            if (accountMenu) {
                accountMenu.classList.remove('show');
            }
        });

        // Sign out function
        async function signOut() {
            if (window.electronAPI) {
                const confirmed = confirm('Are you sure you want to sign out? You will need to re-authenticate with Google to use the app again.');
                if (confirmed) {
                    await window.electronAPI.clearAuth();
                    // Reload the page to show auth screen
                    window.location.reload();
                }
            }
        }

        // Switch account function
        async function switchAccount() {
            if (window.electronAPI) {
                const confirmed = confirm('This will sign you out and open the authentication flow for a new account. Continue?');
                if (confirmed) {
                    await window.electronAPI.clearAuth();
                    // Small delay before starting new auth
                    setTimeout(async () => {
                        await window.electronAPI.startGoogleAuth();
                        // Reload to show auth screen
                        window.location.reload();
                    }, 500);
                }
            }
        }

        // Handle Google Sign In
        async function handleGoogleSignIn() {
            if (window.electronAPI) {
                const signInBtn = document.getElementById('googleSignIn');
                signInBtn.disabled = true;
                signInBtn.textContent = 'Opening Terminal for authentication...';
                
                const result = await window.electronAPI.startGoogleAuth();
                
                if (result.success) {
                    signInBtn.textContent = 'Complete sign-in in Terminal...';
                    
                    const authCheckInterval = setInterval(async () => {
                        const authStatus = await window.electronAPI.checkAuthStatus();
                        if (authStatus.authenticated) {
                            clearInterval(authCheckInterval);
                            signInBtn.textContent = 'Success! Redirecting...';
                            setTimeout(() => {
                                checkAuthStatus();
                            }, 1000);
                        }
                    }, 3000);
                    
                    setTimeout(() => {
                        clearInterval(authCheckInterval);
                        signInBtn.disabled = false;
                        signInBtn.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 48 48" style="margin-right: 8px;">
                                <!-- Google logo SVG paths -->
                            </svg>
                            Sign in with Google
                        `;
                    }, 300000);
                } else {
                    signInBtn.disabled = false;
                    signInBtn.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 48 48" style="margin-right: 8px;">
                            <!-- Google logo SVG paths -->
                        </svg>
                        Sign in with Google
                    `;
                    alert('Failed to start authentication: ' + result.error);
                }
            }
        }

        // Original checkGeminiStatus function as fallback
        async function checkGeminiStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusDot = document.getElementById('geminiStatus');
                const statusText = document.getElementById('geminiStatusText');
                
                if (data.geminiCLI === 'available') {
                    statusDot.style.background = 'var(--success)';
                    statusText.textContent = 'Gemini CLI Ready';
                } else {
                    statusDot.style.background = 'var(--error)';
                    statusText.textContent = 'Gemini CLI Not Found';
                    showError('Please install Gemini CLI to use this application');
                }
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // Use native file dialog if in Electron, otherwise fall back to web input
        dropZone.addEventListener('click', async () => {
            if (window.electronAPI) {
                const filePath = await window.electronAPI.selectPDF();
                if (filePath) {
                    handleNativeFile(filePath);
                }
            } else {
                fileInput.click();
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--accent)';
            dropZone.style.background = 'var(--surface-hover)';
        });

        dropZone.addEventListener('dragleave', () => {
            updateThemeStyles(currentTheme);
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            updateThemeStyles(currentTheme);
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            selectedFile = file;
            selectedFileIsPath = false; // This is a File object, not a path
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.classList.add('collapsed');
            
            dropZone.innerHTML = `
                <div class="drop-zone-icon">
                    <i data-lucide="file-check" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="file-info-compact">
                    <strong title="${file.name}">${file.name}</strong><br>
                    <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                </div>
                <button class="change-file-btn" onclick="resetUpload()">Change File</button>
            `;
            lucide.createIcons();
            
            // Scroll to show actions
            setTimeout(() => {
                document.querySelector('.actions').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        }
        
        // Handle native file selection (Electron)
        function handleNativeFile(filePath) {
            selectedFile = filePath;
            selectedFileIsPath = true; // Flag to know this is a path, not a File object
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.classList.add('collapsed');
            
            const fileName = filePath.split('/').pop();
            const fileInfo = `<small>${filePath}</small>`;
            
            dropZone.innerHTML = `
                <div class="drop-zone-icon">
                    <i data-lucide="file-check" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="file-info-compact">
                    <strong title="${fileName}">${fileName}</strong><br>
                    <small title="${fileInfo}">${fileInfo}</small>
                </div>
                <button class="change-file-btn" onclick="resetUpload()">Change File</button>
            `;
            lucide.createIcons();
            
            // Fetch intelligence for the native file
            fetchIntelligence(filePath);
            
            // Scroll to show actions
            setTimeout(() => {
                document.querySelector('.actions').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        }
        
        // Intelligence Functions
        async function fetchIntelligence(filePath) {
            const card = document.getElementById('intelligenceCard');
            const content = document.getElementById('intelligenceContent');
            
            // Show the card with loading state
            card.style.display = 'block';
            content.innerHTML = `
                <div class="intelligence-loading">
                    <div class="spinner-small"></div>
                    <span>Analyzing document with AI...</span>
                </div>
            `;
            
            try {
                const response = await fetch('/api/intelligence-local', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filePath })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayIntelligence(data);
                } else {
                    throw new Error('Failed to fetch intelligence');
                }
            } catch (error) {
                console.error('Intelligence error:', error);
                content.innerHTML = `
                    <div style="color: var(--text-secondary); text-align: center;">
                        <p>Unable to analyze document at this time</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        function displayIntelligence(data) {
            const content = document.getElementById('intelligenceContent');
            const { summary, insights, metadata } = data;
            
            // Determine badge class based on importance
            const badgeClass = `badge-${summary.importance}`;
            
            content.innerHTML = `
                <div class="intelligence-summary">
                    <h4>${summary.title}</h4>
                    <p>${summary.description}</p>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-size: 0.85rem; opacity: 0.7;">Priority:</span>
                        <span class="intelligence-badge ${badgeClass}">${summary.importance.toUpperCase()}</span>
                        <span style="font-size: 0.85rem; opacity: 0.7; margin-left: 1rem;">Type:</span>
                        <span class="intelligence-badge" style="background: var(--surface-hover); color: var(--text-secondary);">
                            ${summary.category.toUpperCase()}
                        </span>
                    </div>
                </div>
                
                ${insights.completeness > 0 ? `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Document Completeness</span>
                        <strong>${insights.completeness}%</strong>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" style="width: ${insights.completeness}%"></div>
                    </div>
                </div>
                ` : ''}
                
                <div class="intelligence-insights">
                    ${insights.keyInsights && insights.keyInsights.length > 0 ? `
                    <div class="insight-card">
                        <h5>Key Insights</h5>
                        <ul class="insight-list">
                            ${insights.keyInsights.map(insight => `<li>${insight}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${insights.nextActions && insights.nextActions.length > 0 ? `
                    <div class="insight-card">
                        <h5>Recommended Actions</h5>
                        <ul class="insight-list">
                            ${insights.nextActions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${summary.processingTips && summary.processingTips.length > 0 ? `
                    <div class="insight-card">
                        <h5>Processing Tips</h5>
                        <ul class="insight-list">
                            ${summary.processingTips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.85rem; color: var(--text-secondary);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Analysis confidence: ${metadata.confidence}%</span>
                        <span>Processing time: ${(metadata.processingTime / 1000).toFixed(1)}s</span>
                    </div>
                </div>
            `;
        }
        
        function refreshIntelligence() {
            if (selectedFile && selectedFileIsPath) {
                fetchIntelligence(selectedFile);
            }
        }
        
        window.resetUpload = function() {
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.classList.remove('collapsed');
            selectedFile = null;
            selectedFileIsPath = false;
            
            // Hide intelligence card
            document.getElementById('intelligenceCard').style.display = 'none';
            
            const dropZone = document.getElementById('dropZone');
            dropZone.classList.remove('compact');
            dropZone.innerHTML = `
                <div class="drop-zone-icon">
                    <i data-lucide="upload" style="width: 48px; height: 48px;"></i>
                </div>
                <p>Drag & drop your PDF here</p>
                <small>or click to browse</small>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
            `;
            
            // Re-attach file input event
            const newFileInput = document.getElementById('fileInput');
            newFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // Re-attach drop zone click handler
            dropZone.addEventListener('click', () => newFileInput.click());
            
            lucide.createIcons();
            hideResults();
        }

        // Action handlers
        document.querySelectorAll('.action-card').forEach(card => {
            card.addEventListener('click', async () => {
                if (!selectedFile) {
                    showError('Please select a PDF file first');
                    return;
                }
                
                const action = card.dataset.action;
                if (action === 'fill') {
                    await openFormFillModal();
                } else if (action === 'bulk-fill') {
                    await openBulkFillModal();
                } else if (action === 'profiles') {
                    await openProfileModal();
                } else {
                    await processFile(action);
                }
            });
        });

        async function processFile(action) {
            showProcessing();
            hideError();
            hideResults();
            
            console.log('Processing file:', { selectedFile, selectedFileIsPath, action });
            
            // Add to recent files if it's a path
            if (selectedFileIsPath && selectedFile) {
                addToRecentFiles(selectedFile);
            }
            
            // Check if we're using native file paths or web uploads
            let endpoint, body, headers;
            let formData = null; // Declare formData outside the if block
            
            if (window.electronAPI && selectedFileIsPath) {
                // Native file path mode
                endpoint = `/api/${action}-local`;
                headers = { 'Content-Type': 'application/json' };
                body = JSON.stringify({ filePath: selectedFile });
            } else {
                // Web upload mode
                endpoint = `/api/${action}`;
                formData = new FormData();
                formData.append('pdf', selectedFile);
                body = formData;
                headers = {}; // FormData sets its own headers
            }
            
            // Form filling is now handled by the modal - this shouldn't be reached
            if (action === 'fill') {
                throw new Error('Form filling should use the modal interface');
            }
            
            try {
                console.log('Sending request to:', endpoint, 'with headers:', headers);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                if (action === 'fill') {
                    if (window.electronAPI && selectedFileIsPath) {
                        // Native mode - ask where to save
                        const saveResult = await window.electronAPI.savePDF('filled-form.pdf');
                        if (saveResult.success) {
                            // Update the request to save to the chosen path
                            const jsonBody = JSON.parse(body);
                            jsonBody.outputPath = saveResult.filePath;
                            
                            // Re-send the request with output path
                            const saveResponse = await fetch(endpoint, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify(jsonBody)
                            });
                            
                            const result = await saveResponse.json();
                            showResults({ message: `PDF filled and saved to: ${saveResult.filePath}` });
                        }
                    } else {
                        // Web mode - download directly
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `filled-${selectedFile.name}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showResults({ message: 'PDF filled and downloaded!' });
                    }
                } else {
                    const data = await response.json();
                    showResults(data);
                }
            } catch (error) {
                showError(error.message);
            } finally {
                hideProcessing();
            }
        }

        let processingTimer;
        let processingStartTime;
        
        function showProcessing() {
            document.getElementById('processing').style.display = 'block';
            processingStartTime = Date.now();
            
            processingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - processingStartTime) / 1000);
                document.getElementById('processingTimer').textContent = `Processing time: ${elapsed} seconds`;
            }, 1000);
        }

        function hideProcessing() {
            document.getElementById('processing').style.display = 'none';
            if (processingTimer) {
                clearInterval(processingTimer);
                processingTimer = null;
            }
            document.getElementById('processingTimer').textContent = '';
        }

        function showResults(data) {
            currentResult = data;
            const resultsEl = document.getElementById('results');
            resultsEl.style.display = 'flex';
            resultsEl.classList.add('visible');
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre><span class="copy-tooltip">Click to copy</span>`;
            
            // Reset copy button state
            const copyBtn = document.getElementById('copyBtn');
            const copyText = document.getElementById('copyText');
            const copyIcon = document.getElementById('copyIcon');
            copyBtn.classList.remove('copied');
            copyText.textContent = 'Copy JSON';
            copyIcon.textContent = '📋';
            
            // Scroll to results
            setTimeout(() => {
                resultsEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        async function copyToClipboard() {
            if (!currentResult) return;
            
            const jsonString = JSON.stringify(currentResult, null, 2);
            
            try {
                await navigator.clipboard.writeText(jsonString);
                
                // Update button state
                const copyBtn = document.getElementById('copyBtn');
                const copyText = document.getElementById('copyText');
                const copyIcon = document.getElementById('copyIcon');
                
                copyBtn.classList.add('copied');
                copyText.textContent = 'Copied!';
                copyIcon.setAttribute('data-lucide', 'check');
                lucide.createIcons();
                
                // Reset after 2 seconds
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyText.textContent = 'Copy JSON';
                    copyIcon.setAttribute('data-lucide', 'clipboard');
                    lucide.createIcons();
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = jsonString;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    
                    // Update button state
                    const copyBtn = document.getElementById('copyBtn');
                    const copyText = document.getElementById('copyText');
                    const copyIcon = document.getElementById('copyIcon');
                    
                    copyBtn.classList.add('copied');
                    copyText.textContent = 'Copied!';
                    copyIcon.textContent = '✅';
                    
                    setTimeout(() => {
                        copyBtn.classList.remove('copied');
                        copyText.textContent = 'Copy JSON';
                        copyIcon.textContent = '📋';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    showError('Failed to copy to clipboard');
                }
                
                document.body.removeChild(textArea);
            }
        }

        function hideResults() {
            const resultsEl = document.getElementById('results');
            resultsEl.style.display = 'none';
            resultsEl.classList.remove('visible');
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            errorEl.style.background = 'var(--error)';
            errorEl.style.color = 'white';
            errorEl.style.padding = '1rem';
            errorEl.style.borderRadius = '8px';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function downloadResult() {
            if (!currentResult) return;
            
            const blob = new Blob([JSON.stringify(currentResult, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'result.json';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Initialize
        checkAuthStatus();
        
        // Close modal when clicking outside
        document.getElementById('formFillModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFormFillModal();
            }
        });
        
        document.getElementById('bulkFillModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBulkFillModal();
            }
        });

        // Initialize Lucide icons multiple times to ensure they render
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        window.addEventListener('load', () => {
            lucide.createIcons();
        });
        
        // Try immediately as well
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // And after a short delay
        setTimeout(() => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }, 500);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd+, (Mac) or Ctrl+, (Windows/Linux) for settings
            if ((e.metaKey || e.ctrlKey) && e.key === ',') {
                e.preventDefault();
                const settingsView = document.getElementById('settingsView');
                const mainApp = document.getElementById('mainApp');
                
                // Only open settings if authenticated and not already in settings
                if (isAuthenticated && settingsView.style.display !== 'block') {
                    toggleSettings();
                }
            }
            
            // ESC to close modals and settings
            if (e.key === 'Escape') {
                const formModal = document.getElementById('formFillModal');
                const bulkModal = document.getElementById('bulkFillModal');
                const profileModal = document.getElementById('profileModal');
                const saveProfileModal = document.getElementById('saveProfileModal');
                const createProfileModal = document.getElementById('createProfileModal');
                const settingsView = document.getElementById('settingsView');
                
                if (formModal.classList.contains('show')) {
                    e.preventDefault();
                    closeFormFillModal();
                } else if (bulkModal.classList.contains('show')) {
                    e.preventDefault();
                    closeBulkFillModal();
                } else if (profileModal.classList.contains('show')) {
                    e.preventDefault();
                    closeProfileModal();
                } else if (saveProfileModal.classList.contains('show')) {
                    e.preventDefault();
                    closeSaveProfileModal();
                } else if (createProfileModal.classList.contains('show')) {
                    e.preventDefault();
                    closeCreateProfileModal();
                } else if (settingsView.style.display === 'block') {
                    e.preventDefault();
                    toggleSettings();
                }
            }
            
            // Cmd+O (Mac) or Ctrl+O (Windows/Linux) to open a file
            if ((e.metaKey || e.ctrlKey) && e.key === 'o') {
                e.preventDefault();
                const fileInput = document.getElementById('fileInput');
                if (fileInput && isAuthenticated) {
                    fileInput.click();
                }
            }
        });
        
        // Form Fill Modal Functions
        async function openFormFillModal() {
            if (!selectedFile) {
                showError('Please select a PDF file first');
                return;
            }

            currentModalFile = selectedFile;
            const modal = document.getElementById('formFillModal');
            const loading = document.getElementById('modalLoading');
            const fieldsContainer = document.getElementById('formFieldsContainer');
            const modalError = document.getElementById('modalError');
            const fillBtn = document.getElementById('fillFormBtn');

            // Reset modal state
            loading.style.display = 'block';
            fieldsContainer.style.display = 'none';
            modalError.style.display = 'none';
            document.getElementById('passwordSection').style.display = 'none';
            fillBtn.disabled = true;

            // Show modal
            modal.classList.add('show');
            lucide.createIcons();

            try {
                await loadFormFields();
            } catch (error) {
                console.error('Failed to load form fields:', error);
                showModalError(error.message);
            }
        }

        async function loadFormFields(password = null) {
            const loading = document.getElementById('modalLoading');
            const fieldsContainer = document.getElementById('formFieldsContainer');
            const modalError = document.getElementById('modalError');
            const fillBtn = document.getElementById('fillFormBtn');

            loading.style.display = 'block';
            modalError.style.display = 'none';

            try {
                let endpoint, body, headers;

                if (window.electronAPI && selectedFileIsPath) {
                    // Native file path mode
                    endpoint = '/api/read-fields-local';
                    headers = { 'Content-Type': 'application/json' };
                    body = JSON.stringify({ 
                        filePath: currentModalFile,
                        password: password 
                    });
                } else {
                    // Web upload mode
                    endpoint = '/api/read-fields';
                    const formData = new FormData();
                    formData.append('pdf', currentModalFile);
                    if (password) {
                        formData.append('password', password);
                    }
                    body = formData;
                    headers = {};
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 404) {
                        throw new Error('Form field reading endpoint not available. Please ensure your server supports the /api/read-fields-local or /api/read-fields endpoints.');
                    }
                    throw new Error(`Failed to read form fields: ${errorText}`);
                }

                const data = await response.json();
                
                if (data.requiresPassword) {
                    loading.style.display = 'none';
                    document.getElementById('passwordSection').style.display = 'block';
                    return;
                }

                currentFormFields = data.fields || [];
                renderFormFields(currentFormFields);
                
                loading.style.display = 'none';
                fieldsContainer.style.display = 'block';
                profileSection.style.display = 'block';
                fillBtn.disabled = false;
                
                // Refresh icons
                setTimeout(() => lucide.createIcons(), 100);

            } catch (error) {
                loading.style.display = 'none';
                showModalError(error.message);
            }
        }

        function renderFormFields(fields) {
            const container = document.getElementById('formFields');
            container.innerHTML = '';

            if (!fields || fields.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No form fields found in this PDF.</p>';
                return;
            }

            fields.forEach((field, index) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'form-field';

                const label = document.createElement('label');
                label.htmlFor = `field_${index}`;
                label.innerHTML = `
                    ${field.name || `Field ${index + 1}`}
                    <span class="field-type">${field.type || 'text'}</span>
                `;

                let input;
                switch (field.type) {
                    case 'checkbox':
                        const wrapper = document.createElement('div');
                        wrapper.className = 'checkbox-wrapper';
                        input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = `field_${index}`;
                        input.checked = field.value === 'true' || field.value === true;
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.htmlFor = `field_${index}`;
                        checkboxLabel.textContent = field.name || `Field ${index + 1}`;
                        wrapper.appendChild(input);
                        wrapper.appendChild(checkboxLabel);
                        fieldDiv.innerHTML = '';
                        fieldDiv.appendChild(wrapper);
                        break;
                    
                    case 'select':
                    case 'dropdown':
                        input = document.createElement('select');
                        input.id = `field_${index}`;
                        
                        // Add empty option
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = 'Choose an option...';
                        input.appendChild(emptyOption);
                        
                        // Add field options if available
                        if (field.options && Array.isArray(field.options)) {
                            field.options.forEach(option => {
                                const optionEl = document.createElement('option');
                                optionEl.value = option;
                                optionEl.textContent = option;
                                optionEl.selected = option === field.value;
                                input.appendChild(optionEl);
                            });
                        }
                        break;
                    
                    case 'textarea':
                    case 'multiline':
                        input = document.createElement('textarea');
                        input.id = `field_${index}`;
                        input.rows = 3;
                        input.value = field.value || '';
                        break;
                    
                    default:
                        input = document.createElement('input');
                        input.type = 'text';
                        input.id = `field_${index}`;
                        input.value = field.value || '';
                        input.placeholder = `Enter ${field.name || 'value'}`;
                        break;
                }

                if (field.type !== 'checkbox') {
                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                }
                
                container.appendChild(fieldDiv);
            });
        }

        async function fillAndSavePDF() {
            const fillBtn = document.getElementById('fillFormBtn');
            const modalError = document.getElementById('modalError');
            
            fillBtn.disabled = true;
            fillBtn.innerHTML = '<i data-lucide="loader-2" style="width: 16px; height: 16px; margin-right: 0.5rem; animation: spin 1s linear infinite;"></i>Filling PDF...';
            modalError.style.display = 'none';

            try {
                // Collect form data
                const fillData = {};
                currentFormFields.forEach((field, index) => {
                    const input = document.getElementById(`field_${index}`);
                    if (input) {
                        let value;
                        if (input.type === 'checkbox') {
                            value = input.checked;
                        } else {
                            value = input.value;
                        }
                        
                        // Only include non-empty values
                        if (value !== '' && value !== null && value !== undefined) {
                            fillData[field.name || `field_${index}`] = value;
                        }
                    }
                });

                // Get password if provided
                const passwordInput = document.getElementById('pdfPassword');
                const password = passwordInput ? passwordInput.value : null;

                let endpoint, body, headers;
                
                if (window.electronAPI && selectedFileIsPath) {
                    // Native mode - ask where to save first
                    const saveResult = await window.electronAPI.savePDF('filled-form.pdf');
                    if (!saveResult.success) {
                        throw new Error('Save cancelled');
                    }

                    endpoint = '/api/fill-pdf-local';
                    headers = { 'Content-Type': 'application/json' };
                    body = JSON.stringify({ 
                        filePath: currentModalFile,
                        fillData: fillData,
                        outputPath: saveResult.filePath,
                        password: password
                    });
                } else {
                    // Web mode
                    endpoint = '/api/fill-pdf';
                    const formData = new FormData();
                    formData.append('pdf', currentModalFile);
                    formData.append('data', JSON.stringify(fillData));
                    if (password) {
                        formData.append('password', password);
                    }
                    body = formData;
                    headers = {};
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 404) {
                        throw new Error('PDF filling endpoint not available. Please ensure your server supports the /api/fill-pdf-local or /api/fill-pdf endpoints.');
                    }
                    throw new Error(`Failed to fill PDF: ${errorText}`);
                }

                if (window.electronAPI && selectedFileIsPath) {
                    // Native mode - show success message
                    const result = await response.json();
                    showResults({ message: `PDF filled and saved successfully!`, filePath: result.outputPath });
                } else {
                    // Web mode - download the file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `filled-${currentModalFile.name}`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showResults({ message: 'PDF filled and downloaded successfully!' });
                }

                closeFormFillModal();

            } catch (error) {
                showModalError(error.message);
                fillBtn.disabled = false;
                fillBtn.innerHTML = '<i data-lucide="download" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>Fill & Save PDF';
                lucide.createIcons();
            }
        }

        function closeFormFillModal() {
            const modal = document.getElementById('formFillModal');
            modal.classList.remove('show');
            currentFormFields = null;
            currentModalFile = null;
            
            // Reset form
            document.getElementById('formFields').innerHTML = '';
            const passwordInput = document.getElementById('pdfPassword');
            if (passwordInput) {
                passwordInput.value = '';
            }
            
            // Reset button
            const fillBtn = document.getElementById('fillFormBtn');
            fillBtn.disabled = true;
            fillBtn.innerHTML = '<i data-lucide="download" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>Fill & Save PDF';
            
            // Refresh icons
            setTimeout(() => lucide.createIcons(), 100);
        }

        function showModalError(message) {
            const modalError = document.getElementById('modalError');
            modalError.textContent = message;
            modalError.style.display = 'block';
        }

        // Handle password submission
        function submitPassword() {
            const passwordInput = document.getElementById('pdfPassword');
            const password = passwordInput.value.trim();
            if (password) {
                loadFormFields(password);
            } else {
                showModalError('Please enter a password');
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.id === 'pdfPassword') {
                e.preventDefault();
                submitPassword();
            }
        });

        // Listen for settings event from Electron tray
        if (window.electronAPI) {
            window.electronAPI.onOpenSettings(() => {
                if (isAuthenticated) {
                    toggleSettings();
                }
            });
        }

        // Bulk Fill Modal Functions
        let bulkTemplatePath = null;
        let bulkCsvPath = null;
        let bulkOutputPath = null;
        let bulkProcessingResults = null;

        async function openBulkFillModal() {
            const modal = document.getElementById('bulkFillModal');
            const setupSection = document.getElementById('bulkSetupSection');
            const processingSection = document.getElementById('bulkProcessingSection');
            const modalError = document.getElementById('bulkModalError');
            const startBtn = document.getElementById('startBulkFillBtn');

            // Reset modal state
            setupSection.style.display = 'block';
            processingSection.style.display = 'none';
            modalError.style.display = 'none';
            document.getElementById('bulkPasswordSection').style.display = 'none';
            document.getElementById('downloadSummaryBtn').style.display = 'none';
            startBtn.disabled = true;
            
            // Reset file selections
            bulkTemplatePath = null;
            bulkCsvPath = null;
            bulkOutputPath = null;
            bulkProcessingResults = null;
            
            document.getElementById('templatePDF').value = '';
            document.getElementById('csvFile').value = '';
            document.getElementById('outputDirectory').value = '';
            document.getElementById('bulkPdfPassword').value = '';

            // Show modal
            modal.classList.add('show');
            lucide.createIcons();
        }

        async function selectTemplatePDF() {
            if (window.electronAPI) {
                const result = await window.electronAPI.selectPDF();
                if (result.success) {
                    bulkTemplatePath = result.filePath;
                    document.getElementById('templatePDF').value = result.filePath.split('/').pop();
                    checkBulkFormReady();
                }
            } else {
                showBulkModalError('File selection is only available in the desktop app');
            }
        }

        async function selectCSVFile() {
            if (window.electronAPI) {
                const result = await window.electronAPI.selectFile([
                    { name: 'CSV Files', extensions: ['csv'] },
                    { name: 'All Files', extensions: ['*'] }
                ]);
                if (result.success) {
                    bulkCsvPath = result.filePath;
                    document.getElementById('csvFile').value = result.filePath.split('/').pop();
                    checkBulkFormReady();
                }
            } else {
                showBulkModalError('File selection is only available in the desktop app');
            }
        }

        async function selectOutputDirectory() {
            if (window.electronAPI) {
                const result = await window.electronAPI.selectDirectory();
                if (result.success) {
                    bulkOutputPath = result.filePath;
                    document.getElementById('outputDirectory').value = result.filePath;
                    checkBulkFormReady();
                }
            } else {
                showBulkModalError('Directory selection is only available in the desktop app');
            }
        }

        function checkBulkFormReady() {
            const startBtn = document.getElementById('startBulkFillBtn');
            const namingPattern = document.getElementById('namingPattern').value.trim();
            
            if (bulkTemplatePath && bulkCsvPath && bulkOutputPath && namingPattern) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }

        // Add event listener for naming pattern input
        document.getElementById('namingPattern').addEventListener('input', checkBulkFormReady);

        async function startBulkFill() {
            const setupSection = document.getElementById('bulkSetupSection');
            const processingSection = document.getElementById('bulkProcessingSection');
            const modalError = document.getElementById('bulkModalError');
            const startBtn = document.getElementById('startBulkFillBtn');
            
            // Validate inputs
            if (!bulkTemplatePath || !bulkCsvPath || !bulkOutputPath) {
                showBulkModalError('Please select all required files and directories');
                return;
            }
            
            const namingPattern = document.getElementById('namingPattern').value.trim();
            if (!namingPattern) {
                showBulkModalError('Please enter a file naming pattern');
                return;
            }

            // Hide setup, show processing
            setupSection.style.display = 'none';
            processingSection.style.display = 'block';
            modalError.style.display = 'none';
            startBtn.disabled = true;
            
            // Reset progress
            updateBulkProgress(0, 0, 'Preparing to process files...');
            document.getElementById('bulkResultsSummary').style.display = 'none';
            document.getElementById('bulkErrorContainer').style.display = 'none';

            try {
                // Get password if provided
                const password = document.getElementById('bulkPdfPassword').value || null;

                const requestBody = {
                    templatePath: bulkTemplatePath,
                    csvPath: bulkCsvPath,
                    outputPath: bulkOutputPath,
                    namingPattern: namingPattern,
                    password: password
                };

                const response = await fetch('/api/bulk-fill-local', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const update = JSON.parse(line);
                                handleBulkUpdate(update);
                            } catch (e) {
                                console.warn('Failed to parse update:', line);
                            }
                        }
                    }
                }
                
                // Process any remaining buffer
                if (buffer.trim()) {
                    try {
                        const update = JSON.parse(buffer);
                        handleBulkUpdate(update);
                    } catch (e) {
                        console.warn('Failed to parse final update:', buffer);
                    }
                }

            } catch (error) {
                console.error('Bulk fill error:', error);
                setupSection.style.display = 'block';
                processingSection.style.display = 'none';
                showBulkModalError(error.message);
                startBtn.disabled = false;
            }
        }

        function handleBulkUpdate(update) {
            if (update.type === 'progress') {
                updateBulkProgress(update.completed, update.total, update.message);
            } else if (update.type === 'complete') {
                bulkProcessingResults = update.results;
                showBulkResults(update.results);
                document.getElementById('downloadSummaryBtn').style.display = 'block';
            } else if (update.type === 'error') {
                showBulkModalError(update.message);
            } else if (update.type === 'requiresPassword') {
                document.getElementById('bulkPasswordSection').style.display = 'block';
                document.getElementById('bulkSetupSection').style.display = 'block';
                document.getElementById('bulkProcessingSection').style.display = 'none';
                document.getElementById('startBulkFillBtn').disabled = false;
                showBulkModalError('This PDF requires a password. Please enter it and try again.');
            }
        }

        function updateBulkProgress(completed, total, message) {
            const progressFill = document.getElementById('bulkProgressFill');
            const progressText = document.getElementById('bulkProgressText');
            const progressCount = document.getElementById('bulkProgressCount');
            const progressPercent = document.getElementById('bulkProgressPercent');
            
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = message;
            progressCount.textContent = `${completed} / ${total}`;
            progressPercent.textContent = `${percentage}%`;
        }

        function showBulkResults(results) {
            const summaryContainer = document.getElementById('bulkResultsSummary');
            const errorContainer = document.getElementById('bulkErrorContainer');
            const errorList = document.getElementById('bulkErrorList');
            const successCount = document.getElementById('successCount');
            const failureCount = document.getElementById('failureCount');
            
            // Update summary stats
            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            successCount.textContent = successful;
            failureCount.textContent = failed;
            summaryContainer.style.display = 'grid';
            
            // Show errors if any
            const errors = results.filter(r => !r.success);
            if (errors.length > 0) {
                errorContainer.style.display = 'block';
                errorList.innerHTML = '';
                
                errors.forEach(error => {
                    const errorItem = document.createElement('div');
                    errorItem.className = 'error-item';
                    errorItem.innerHTML = `
                        <div class="error-row">Row ${error.row}</div>
                        <div class="error-message">${error.error}</div>
                    `;
                    errorList.appendChild(errorItem);
                });
            } else {
                errorContainer.style.display = 'none';
            }
            
            // Update final progress message
            updateBulkProgress(results.length, results.length, 
                `Complete! ${successful} successful, ${failed} failed`);
        }

        function downloadBulkSummary() {
            if (!bulkProcessingResults) return;
            
            const summary = {
                timestamp: new Date().toISOString(),
                template: bulkTemplatePath,
                csvFile: bulkCsvPath,
                outputDirectory: bulkOutputPath,
                totalRows: bulkProcessingResults.length,
                successful: bulkProcessingResults.filter(r => r.success).length,
                failed: bulkProcessingResults.filter(r => !r.success).length,
                results: bulkProcessingResults
            };
            
            const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bulk-fill-summary-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function closeBulkFillModal() {
            const modal = document.getElementById('bulkFillModal');
            modal.classList.remove('show');
            
            // Reset state
            bulkTemplatePath = null;
            bulkCsvPath = null;
            bulkOutputPath = null;
            bulkProcessingResults = null;
            
            // Reset form
            document.getElementById('templatePDF').value = '';
            document.getElementById('csvFile').value = '';
            document.getElementById('outputDirectory').value = '';
            document.getElementById('bulkPdfPassword').value = '';
            document.getElementById('namingPattern').value = 'filled_{row}_{timestamp}';
            
            // Reset sections
            document.getElementById('bulkSetupSection').style.display = 'block';
            document.getElementById('bulkProcessingSection').style.display = 'none';
            document.getElementById('bulkPasswordSection').style.display = 'none';
            document.getElementById('bulkModalError').style.display = 'none';
            document.getElementById('downloadSummaryBtn').style.display = 'none';
            
            // Reset button
            const startBtn = document.getElementById('startBulkFillBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i data-lucide="play" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>Start Processing';
            
            // Refresh icons
            setTimeout(() => lucide.createIcons(), 100);
        }

        function showBulkModalError(message) {
            const modalError = document.getElementById('bulkModalError');
            modalError.textContent = message;
            modalError.style.display = 'block';
        }

        // Profile Management Functions
        let currentProfiles = [];
        let currentEditProfileId = null;

        async function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('show');
            await loadProfiles();
            lucide.createIcons();
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('show');
        }

        async function loadProfiles() {
            const profileList = document.getElementById('profileList');
            
            try {
                const response = await fetch('/api/profiles');
                if (!response.ok) throw new Error('Failed to load profiles');
                
                currentProfiles = await response.json();
                renderProfileList();
            } catch (error) {
                console.error('Error loading profiles:', error);
                profileList.innerHTML = `
                    <div class="empty-profiles">
                        <i data-lucide="alert-circle"></i>
                        <p>Error loading profiles</p>
                        <small>${error.message}</small>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function renderProfileList() {
            const profileList = document.getElementById('profileList');
            
            if (currentProfiles.length === 0) {
                profileList.innerHTML = `
                    <div class="empty-profiles">
                        <i data-lucide="user-plus"></i>
                        <p>No profiles saved yet</p>
                        <small>Create your first profile to save form data for reuse</small>
                    </div>
                `;
            } else {
                profileList.innerHTML = currentProfiles.map(profile => `
                    <div class="profile-item ${profile.isDefault ? 'default' : ''}">
                        <div class="profile-header">
                            <div class="profile-info">
                                <div class="profile-name">
                                    ${escapeHtml(profile.name)}
                                    ${profile.isDefault ? '<span class="default-badge">Default</span>' : ''}
                                </div>
                                ${profile.description ? `<div class="profile-description">${escapeHtml(profile.description)}</div>` : ''}
                                ${profile.tags && profile.tags.length > 0 ? `
                                    <div class="profile-tags">
                                        ${profile.tags.map(tag => `<span class="profile-tag">${escapeHtml(tag)}</span>`).join('')}
                                    </div>
                                ` : ''}
                                <div class="profile-meta">
                                    <span><i data-lucide="calendar" style="width: 12px; height: 12px; margin-right: 0.25rem;"></i>${new Date(profile.createdAt).toLocaleDateString()}</span>
                                    <span><i data-lucide="edit-3" style="width: 12px; height: 12px; margin-right: 0.25rem;"></i>${Object.keys(profile.data).length} fields</span>
                                </div>
                                <div class="profile-fields-preview">
                                    ${Object.keys(profile.data).slice(0, 3).map(key => `${key}: ${escapeHtml(String(profile.data[key]).substring(0, 30))}${String(profile.data[key]).length > 30 ? '...' : ''}`).join(', ')}
                                    ${Object.keys(profile.data).length > 3 ? `... and ${Object.keys(profile.data).length - 3} more` : ''}
                                </div>
                            </div>
                            <div class="profile-actions">
                                <button class="icon-btn" onclick="editProfile('${profile.id}')" title="Edit">
                                    <i data-lucide="edit-2"></i>
                                </button>
                                <button class="icon-btn" onclick="toggleDefaultProfile('${profile.id}')" title="${profile.isDefault ? 'Remove default' : 'Set as default'}">
                                    <i data-lucide="${profile.isDefault ? 'star' : 'star'}"></i>
                                </button>
                                <button class="icon-btn" onclick="deleteProfile('${profile.id}')" title="Delete" style="color: var(--error);">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            lucide.createIcons();
        }

        async function loadProfilesForSelect() {
            const profileSelect = document.getElementById('profileSelect');
            
            try {
                const response = await fetch('/api/profiles');
                if (!response.ok) throw new Error('Failed to load profiles');
                
                const profiles = await response.json();
                profileSelect.innerHTML = '<option value="">Select a profile...</option>' +
                    profiles.map(profile => `<option value="${profile.id}">${escapeHtml(profile.name)}</option>`).join('');
            } catch (error) {
                console.error('Error loading profiles for select:', error);
                profileSelect.innerHTML = '<option value="">Error loading profiles</option>';
            }
        }

        async function loadSelectedProfile() {
            const profileSelect = document.getElementById('profileSelect');
            const selectedId = profileSelect.value;
            
            if (!selectedId) return;
            
            try {
                const response = await fetch(`/api/profiles/${selectedId}`);
                if (!response.ok) throw new Error('Failed to load profile');
                
                const profile = await response.json();
                
                // Fill form fields with profile data
                Object.entries(profile.data).forEach(([fieldName, value]) => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        field.value = value;
                    }
                });
                
                // Show success message briefly
                const loadBtn = document.getElementById('loadProfileBtn');
                const originalText = loadBtn.innerHTML;
                loadBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>Loaded';
                loadBtn.disabled = true;
                
                setTimeout(() => {
                    loadBtn.innerHTML = originalText;
                    loadBtn.disabled = false;
                    lucide.createIcons();
                }, 1500);
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading profile:', error);
                showModalError(error.message);
            }
        }

        function openSaveProfileModal() {
            // Get current form data
            const formData = {};
            const formFields = document.querySelectorAll('#formFields input, #formFields textarea, #formFields select');
            
            formFields.forEach(field => {
                if (field.value.trim()) {
                    formData[field.name] = field.value.trim();
                }
            });
            
            if (Object.keys(formData).length === 0) {
                showModalError('Please fill in some form fields before saving as a profile.');
                return;
            }
            
            currentProfileData = formData;
            
            const modal = document.getElementById('saveProfileModal');
            modal.classList.add('show');
            
            // Clear form
            document.getElementById('profileName').value = '';
            document.getElementById('profileDescription').value = '';
            document.getElementById('profileTags').value = '';
            document.getElementById('setAsDefault').checked = false;
            
            lucide.createIcons();
        }

        function closeSaveProfileModal() {
            const modal = document.getElementById('saveProfileModal');
            modal.classList.remove('show');
            currentProfileData = null;
        }

        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const description = document.getElementById('profileDescription').value.trim();
            const tags = document.getElementById('profileTags').value.split(',').map(t => t.trim()).filter(t => t);
            const isDefault = document.getElementById('setAsDefault').checked;
            const errorDiv = document.getElementById('saveProfileError');
            
            errorDiv.style.display = 'none';
            
            if (!name) {
                errorDiv.textContent = 'Profile name is required';
                errorDiv.style.display = 'block';
                return;
            }
            
            const saveBtn = document.getElementById('saveProfileBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i data-lucide="loader-2" style="width: 16px; height: 16px; margin-right: 0.5rem; animation: spin 1s linear infinite;"></i>Saving...';
            
            try {
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        tags,
                        isDefault,
                        data: currentProfileData
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save profile');
                }
                
                closeSaveProfileModal();
                await loadProfilesForSelect(); // Refresh the select dropdown
                
                // Show success message
                const saveAsBtn = document.getElementById('saveAsProfileBtn');
                const originalSaveAsText = saveAsBtn.innerHTML;
                saveAsBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>Saved';
                
                setTimeout(() => {
                    saveAsBtn.innerHTML = originalSaveAsText;
                    lucide.createIcons();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving profile:', error);
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        function openCreateProfileModal() {
            currentEditProfileId = null;
            const modal = document.getElementById('createProfileModal');
            const title = document.getElementById('createProfileTitle');
            const btnText = document.getElementById('createProfileBtnText');
            
            title.innerHTML = '<i data-lucide="plus" style="width: 20px; height: 20px;"></i>Create New Profile';
            btnText.textContent = 'Create Profile';
            
            // Clear form
            document.getElementById('createProfileName').value = '';
            document.getElementById('createProfileDescription').value = '';
            document.getElementById('createProfileTags').value = '';
            document.getElementById('createSetAsDefault').checked = false;
            
            // Render common fields template
            renderCommonFields();
            
            modal.classList.add('show');
            lucide.createIcons();
        }

        function closeCreateProfileModal() {
            const modal = document.getElementById('createProfileModal');
            modal.classList.remove('show');
            currentEditProfileId = null;
        }

        function renderCommonFields() {
            const fieldsContainer = document.getElementById('createProfileFields');
            
            const commonFields = [
                { name: 'firstName', label: 'First Name', type: 'text' },
                { name: 'lastName', label: 'Last Name', type: 'text' },
                { name: 'email', label: 'Email', type: 'email' },
                { name: 'phone', label: 'Phone', type: 'tel' },
                { name: 'address', label: 'Address', type: 'text' },
                { name: 'city', label: 'City', type: 'text' },
                { name: 'state', label: 'State', type: 'text' },
                { name: 'zip', label: 'ZIP Code', type: 'text' },
                { name: 'country', label: 'Country', type: 'text' },
                { name: 'company', label: 'Company', type: 'text' },
                { name: 'title', label: 'Job Title', type: 'text' },
                { name: 'ssn', label: 'SSN', type: 'text' },
                { name: 'dateOfBirth', label: 'Date of Birth', type: 'date' }
            ];
            
            fieldsContainer.innerHTML = commonFields.map(field => `
                <div class="profile-field">
                    <label for="profile_${field.name}">${field.label}</label>
                    <input type="${field.type}" id="profile_${field.name}" name="${field.name}" placeholder="Enter ${field.label.toLowerCase()}">
                </div>
            `).join('');
        }

        async function createProfile() {
            const name = document.getElementById('createProfileName').value.trim();
            const description = document.getElementById('createProfileDescription').value.trim();
            const tags = document.getElementById('createProfileTags').value.split(',').map(t => t.trim()).filter(t => t);
            const isDefault = document.getElementById('createSetAsDefault').checked;
            const errorDiv = document.getElementById('createProfileError');
            
            errorDiv.style.display = 'none';
            
            if (!name) {
                errorDiv.textContent = 'Profile name is required';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Collect field data
            const data = {};
            const fields = document.querySelectorAll('#createProfileFields input');
            fields.forEach(field => {
                if (field.value.trim()) {
                    data[field.name] = field.value.trim();
                }
            });
            
            const createBtn = document.getElementById('createProfileBtn');
            const originalText = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<i data-lucide="loader-2" style="width: 16px; height: 16px; margin-right: 0.5rem; animation: spin 1s linear infinite;"></i>Saving...';
            
            try {
                const method = currentEditProfileId ? 'PUT' : 'POST';
                const url = currentEditProfileId ? `/api/profiles/${currentEditProfileId}` : '/api/profiles';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, tags, isDefault, data })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save profile');
                }
                
                closeCreateProfileModal();
                await loadProfiles(); // Refresh profile list
                
            } catch (error) {
                console.error('Error saving profile:', error);
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        async function editProfile(profileId) {
            try {
                const response = await fetch(`/api/profiles/${profileId}`);
                if (!response.ok) throw new Error('Failed to load profile');
                
                const profile = await response.json();
                currentEditProfileId = profileId;
                
                const modal = document.getElementById('createProfileModal');
                const title = document.getElementById('createProfileTitle');
                const btnText = document.getElementById('createProfileBtnText');
                
                title.innerHTML = '<i data-lucide="edit-2" style="width: 20px; height: 20px;"></i>Edit Profile';
                btnText.textContent = 'Update Profile';
                
                // Fill form with profile data
                document.getElementById('createProfileName').value = profile.name;
                document.getElementById('createProfileDescription').value = profile.description || '';
                document.getElementById('createProfileTags').value = profile.tags ? profile.tags.join(', ') : '';
                document.getElementById('createSetAsDefault').checked = profile.isDefault;
                
                // Render fields and fill with data
                renderCommonFields();
                
                Object.entries(profile.data).forEach(([fieldName, value]) => {
                    const field = document.querySelector(`#createProfileFields [name="${fieldName}"]`);
                    if (field) {
                        field.value = value;
                    }
                });
                
                modal.classList.add('show');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading profile for edit:', error);
                showProfileModalError(error.message);
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('Are you sure you want to delete this profile? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/profiles/${profileId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to delete profile');
                }
                
                await loadProfiles(); // Refresh profile list
                
            } catch (error) {
                console.error('Error deleting profile:', error);
                showProfileModalError(error.message);
            }
        }

        async function toggleDefaultProfile(profileId) {
            try {
                const response = await fetch(`/api/profiles/${profileId}/default`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update default profile');
                }
                
                await loadProfiles(); // Refresh profile list
                
            } catch (error) {
                console.error('Error updating default profile:', error);
                showProfileModalError(error.message);
            }
        }

        async function exportProfiles() {
            try {
                const response = await fetch('/api/profiles/export');
                if (!response.ok) throw new Error('Failed to export profiles');
                
                const profiles = await response.json();
                const dataStr = JSON.stringify(profiles, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = window.URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `profiles-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error exporting profiles:', error);
                showProfileModalError(error.message);
            }
        }

        function importProfiles() {
            document.getElementById('profileImportInput').click();
        }

        async function handleProfileImport(file) {
            try {
                const text = await file.text();
                const profiles = JSON.parse(text);
                
                if (!Array.isArray(profiles)) {
                    throw new Error('Invalid file format: expected an array of profiles');
                }
                
                const response = await fetch('/api/profiles/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profiles })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to import profiles');
                }
                
                const result = await response.json();
                await loadProfiles(); // Refresh profile list
                
                alert(`Successfully imported ${result.imported} profiles. ${result.skipped} duplicates were skipped.`);
                
            } catch (error) {
                console.error('Error importing profiles:', error);
                showProfileModalError(error.message);
            }
        }

        function showProfileModalError(message) {
            const modalError = document.getElementById('profileModalError');
            modalError.textContent = message;
            modalError.style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Recent Files Sidebar Management
        let recentFiles = [];
        let sidebarOpen = false;
        
        // Load recent files from localStorage
        function loadRecentFilesFromStorage() {
            try {
                const stored = localStorage.getItem('recentFiles');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed)) {
                        recentFiles = parsed;
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error loading recent files from localStorage:', error);
            }
            return false;
        }
        
        // Save recent files to localStorage
        function saveRecentFilesToStorage() {
            try {
                localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
            } catch (error) {
                console.error('Error saving recent files to localStorage:', error);
            }
        }
        
        // Initialize sidebar on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSidebar();
            loadRecentFiles();
        });
        
        function initializeSidebar() {
            const sidebar = document.getElementById('recentFilesSidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const mainContent = document.querySelector('.main-content');
            const clearBtn = document.getElementById('clearRecentFiles');
            const searchInput = document.getElementById('recentFilesSearch');
            
            // Load sidebar state from localStorage
            const savedState = localStorage.getItem('sidebarOpen');
            if (savedState !== null) {
                sidebarOpen = savedState === 'true';
            } else {
                // Default to open on desktop, closed on mobile
                sidebarOpen = window.innerWidth > 768;
            }
            
            updateSidebarState();
            updateHeaderToggleIcon();
            
            // Toggle sidebar
            function toggleSidebar() {
                sidebarOpen = !sidebarOpen;
                updateSidebarState();
                saveSidebarState();
                updateHeaderToggleIcon();
            }
            
            // Update header toggle icon based on sidebar state
            function updateHeaderToggleIcon() {
                const headerToggle = document.getElementById('headerSidebarToggle');
                if (headerToggle) {
                    const icon = headerToggle.querySelector('i');
                    if (icon) {
                        icon.setAttribute('data-lucide', sidebarOpen ? 'panel-left-close' : 'panel-left-open');
                        lucide.replace(); // Re-render the icon
                    }
                }
            }
            
            // Update sidebar visual state
            function updateSidebarState() {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // Mobile behavior
                    sidebar.classList.toggle('open', sidebarOpen);
                    sidebarOverlay.classList.toggle('show', sidebarOpen);
                    mainContent.classList.remove('with-sidebar');
                    
                    // Prevent body scroll when sidebar is open on mobile
                    document.body.style.overflow = sidebarOpen ? 'hidden' : '';
                } else {
                    // Desktop behavior
                    sidebar.classList.toggle('collapsed', !sidebarOpen);
                    mainContent.classList.toggle('with-sidebar', sidebarOpen);
                    mainContent.classList.toggle('sidebar-collapsed', !sidebarOpen);
                    sidebarOverlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
            
            // Save sidebar state to localStorage
            function saveSidebarState() {
                localStorage.setItem('sidebarOpen', sidebarOpen.toString());
            }
            
            // Event listeners
            sidebarToggle.addEventListener('click', toggleSidebar);
            mobileSidebarToggle.addEventListener('click', toggleSidebar);
            
            // Add header toggle listener
            const headerSidebarToggle = document.getElementById('headerSidebarToggle');
            if (headerSidebarToggle) {
                headerSidebarToggle.addEventListener('click', toggleSidebar);
            }
            sidebarOverlay.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebarOpen = false;
                    updateSidebarState();
                    saveSidebarState();
                }
            });
            
            // Clear recent files
            clearBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to clear all recent files?')) {
                    try {
                        if (window.electronAPI && window.electronAPI.clearRecentFiles) {
                            await window.electronAPI.clearRecentFiles();
                        }
                        recentFiles = [];
                        // Clear from localStorage as well
                        localStorage.removeItem('recentFiles');
                        updateRecentFilesList();
                    } catch (error) {
                        console.error('Error clearing recent files:', error);
                    }
                }
            });
            
            // Search functionality
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterRecentFiles(searchTerm);
            });
            
            // Handle window resize
            window.addEventListener('resize', updateSidebarState);
            
            // Add keyboard shortcut for sidebar toggle (Cmd+B on Mac, Ctrl+B on Windows/Linux)
            document.addEventListener('keydown', (e) => {
                // Check for Cmd+B (Mac) or Ctrl+B (Windows/Linux)
                if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
                    e.preventDefault(); // Prevent browser bookmarks
                    toggleSidebar();
                }
            });
        }
        
        // Load recent files from Electron
        async function loadRecentFiles() {
            try {
                if (window.electronAPI && window.electronAPI.getRecentFiles) {
                    // Try to get from Electron first
                    recentFiles = await window.electronAPI.getRecentFiles() || [];
                    // If empty, try localStorage as fallback
                    if (recentFiles.length === 0) {
                        loadRecentFilesFromStorage();
                    }
                } else {
                    // No Electron API, use localStorage
                    loadRecentFilesFromStorage();
                }
                updateRecentFilesList();
            } catch (error) {
                console.error('Error loading recent files:', error);
                // Fallback to localStorage
                loadRecentFilesFromStorage();
                updateRecentFilesList();
            }
        }
        
        // Add a file to recent files
        async function addToRecentFiles(filePath) {
            try {
                const fileName = filePath.split('/').pop() || filePath.split('\\').pop() || 'unknown.pdf';
                const newFile = {
                    path: filePath,
                    name: fileName,
                    lastUsed: new Date().toISOString()
                };
                
                // Remove if already exists (to move to top)
                recentFiles = recentFiles.filter(f => f.path !== filePath);
                
                // Add to beginning
                recentFiles.unshift(newFile);
                
                // Keep only the most recent 10 files
                recentFiles = recentFiles.slice(0, 10);
                
                // Save via Electron if available
                if (window.electronAPI) {
                    // Note: The Electron main process handles persistence
                    // We just update our local array and UI
                }
                
                // Always save to localStorage as well (for persistence)
                saveRecentFilesToStorage();
                
                // Update UI
                updateRecentFilesList();
            } catch (error) {
                console.error('Error adding to recent files:', error);
            }
        }
        
        // Update recent files list in UI
        function updateRecentFilesList() {
            const container = document.getElementById('recentFilesList');
            
            if (!recentFiles || recentFiles.length === 0) {
                container.innerHTML = `
                    <div class="no-recent-files">
                        <i data-lucide="file-text" style="width: 32px; height: 32px; opacity: 0.3;"></i>
                        <p>No recent files</p>
                        <small>Upload a PDF to get started</small>
                    </div>
                `;
                // Re-initialize Lucide icons
                if (window.lucide) {
                    lucide.createIcons();
                }
                return;
            }
            
            const html = recentFiles.map(file => createRecentFileItem(file)).join('');
            container.innerHTML = html;
            
            // Re-initialize Lucide icons
            if (window.lucide) {
                lucide.createIcons();
            }
            
            // Add event listeners to action buttons
            container.querySelectorAll('.recent-file-action').forEach(btn => {
                btn.addEventListener('click', handleRecentFileAction);
            });
        }
        
        // Create HTML for a recent file item
        function createRecentFileItem(file) {
            const fileName = file.name || 'Unknown File';
            const filePath = file.path || '';
            const lastAccessed = file.lastUsed ? new Date(file.lastUsed).toLocaleString() : 'Unknown';
            
            return `
                <div class="recent-file-item" data-file-path="${escapeHtml(filePath)}">
                    <div class="recent-file-name" title="${escapeHtml(fileName)}">${escapeHtml(fileName)}</div>
                    <div class="recent-file-time">${lastAccessed}</div>
                    <div class="recent-file-actions">
                        <button class="recent-file-action" data-action="analyze">
                            <i data-lucide="search" style="width: 12px; height: 12px;"></i>
                            Analyze
                        </button>
                        <button class="recent-file-action" data-action="extract">
                            <i data-lucide="database" style="width: 12px; height: 12px;"></i>
                            Extract
                        </button>
                        <button class="recent-file-action" data-action="fill">
                            <i data-lucide="pen-tool" style="width: 12px; height: 12px;"></i>
                            Fill
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Handle recent file action clicks
        async function handleRecentFileAction(e) {
            e.stopPropagation();
            
            const button = e.currentTarget;
            const action = button.getAttribute('data-action');
            const fileItem = button.closest('.recent-file-item');
            const filePath = fileItem.getAttribute('data-file-path');
            
            if (!filePath) {
                console.error('No file path found');
                return;
            }
            
            try {
                // Set the file path for processing
                const fileName = filePath.split('/').pop() || 'unknown.pdf';
                
                // Set the selected file as a path (existing pattern in the app)
                selectedFile = filePath;
                selectedFileIsPath = true;
                
                // Update UI to show file is selected (simulate file selection)
                const dropZone = document.getElementById('dropZone');
                dropZone.innerHTML = `
                    <div class="drop-zone-icon">
                        <i data-lucide="check-circle" style="width: 48px; height: 48px; color: var(--accent);"></i>
                    </div>
                    <p style="color: var(--accent); font-weight: 500;">${fileName}</p>
                    <small>Ready to process</small>
                `;
                
                // Re-initialize Lucide icons
                if (window.lucide) {
                    lucide.createIcons();
                }
                
                // Trigger the action using processFile function
                switch (action) {
                    case 'analyze':
                        await processFile('analyze');
                        break;
                    case 'extract':
                        await processFile('extract');
                        break;
                    case 'fill':
                        await processFile('fill');
                        break;
                    default:
                        console.warn('Unknown action:', action);
                }
                
                // Close sidebar on mobile after action
                if (window.innerWidth <= 768) {
                    sidebarOpen = false;
                    document.getElementById('recentFilesSidebar').classList.remove('open');
                    document.getElementById('sidebarOverlay').classList.remove('show');
                    document.body.style.overflow = '';
                }
                
            } catch (error) {
                console.error('Error handling recent file action:', error);
                showError('Failed to process file: ' + error.message);
            }
        }
        
        // Filter recent files based on search term
        function filterRecentFiles(searchTerm) {
            const fileItems = document.querySelectorAll('.recent-file-item');
            
            fileItems.forEach(item => {
                const fileName = item.querySelector('.recent-file-name').textContent.toLowerCase();
                const matches = fileName.includes(searchTerm);
                item.classList.toggle('hidden', !matches);
            });
        }
        
        // Listen for recent files updates from Electron
        if (window.electronAPI && window.electronAPI.onRecentFilesUpdated) {
            window.electronAPI.onRecentFilesUpdated((updatedFiles) => {
                recentFiles = updatedFiles || [];
                updateRecentFilesList();
            });
        }
        
        // Refresh icons after theme changes
        const originalApplyTheme = applyTheme;
        if (typeof originalApplyTheme === 'function') {
            window.applyTheme = function(themeName) {
                originalApplyTheme(themeName);
                // Re-initialize icons after theme change
                setTimeout(() => {
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                }, 100);
            };
        }

        // Global variable to store current profile data when saving
        let currentProfileData = null;
    </script>
</body>
</html>